<div class="container-fluid text-center tabcontainer alwaysreload" id="samples_tab">
   <div id="mdl_holder"></div>
   <div class="container-fluid text-center" id="sample_content">
       <div class="table-responsive">
         <table class="table table-condensed table-striped table-bordered samplestbl">
           <thead><tr><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
           <tbody></tbody>
         </table>
       </div>
   </div>
</div>

<script type="text/javascript">
$("#samples_tab").on("lg.loaded.bs.tab", function() {
  let display_sample = function(sample_obj) {
    $.when($.ajax("../../static/html/ms/sampledisplay.html"), $.getJSON("ws/get_modal_param_definitions", { modal_type: "samples" }))
    .done(function(d0, d1){
        let tmpl = d0[0], pdd = _.keyBy(_.get(d1[0], "value.params", []), "param_name");
        _.each(_.get(sample_obj, 'params', {}), function(v,k,o){  if(_.has(pdd, k)) { pdd[k]["current_val"] = v } else { pdd[k] = { required: false, param_name: k, current_val: v }}})
        _.each(pdd, function(v,k,o){
            v["is_"+ _.get(v, "param_type", "string")] = true;
            _.defaults(v, {"label": _.get(v, "param_name")});
            _.defaults(v, {"description": _.get(v, "description")});
            if(_.get(v, "param_type", "string") == "bool") {v["is_checked"] = _.get(sample_obj, "params." + v["param_name"], false)}
            if(_.has(v, "options")){ _.each(v["options"], function(x){ if(_.get(x, "value", x) == _.get(v, "current_val")) { v["current_val"] = _.get(x, "label", x) }})}
        })
        sample_obj.paramkvs = _.values(pdd);
        Mustache.parse(tmpl);
        var rendered = $(Mustache.render(tmpl, sample_obj));
        $("#samples_tab").find("#mdl_holder").append(rendered);
        $("#samples_tab").find("#mdl_holder").find(".modal").on("hidden.bs.modal", function(){ $("#samples_tab").find("#mdl_holder").empty(); });
        $("#samples_tab").find("#mdl_holder").find(".modal").modal("show");
    })
  }

  var edit_sample = function(sample_obj) {
    $.when($.ajax("../../static/html/ms/sampleedit.html"), $.getJSON("ws/get_modal_param_definitions", { modal_type: "samples" }))
    .done(function(d0, d1){
      var tmpl = d0[0], ss_param_defs = _.get(d1[0], "value.params", []), ss_required_param_names = _.map(_.filter(ss_param_defs, function(d) { return _.get(d, "required", false) }), "param_name");
      let pdd = _.keyBy(ss_param_defs, "param_name");
      _.each(_.get(sample_obj, 'params', {}), function(v,k,o){  if(_.has(pdd, k)) { pdd[k]["current_val"] = v } else { pdd[k] = { required: false, param_name: k, current_val: v }}})
      _.each(pdd, function(v,k,o){ // Prep the param definitions.
          v["is_"+ _.get(v, "param_type", "string")] = true;
          _.defaults(v, {"label": _.get(v, "param_name")});
          if(_.get(v, "param_type", "string") == "bool") {v["is_checked"] = _.get(sample_obj, "params." + v["param_name"], false)}
          if(_.has(v, "options")){ v["exp_options"] = _.map(v["options"], function(x){ return {"option_label": _.get(x, "label", x), "option_value": _.get(x, "value", x), "issel": _.get(x, "value", x) == _.get(v, "current_val")}})}
      })
      sample_obj.sample_description = _.get(sample_obj, "description"); _.unset(sample_obj, "description");
      sample_obj.paramkvs = _.values(pdd);
      Mustache.parse(tmpl);
      var rendered = $(Mustache.render(tmpl, sample_obj)), param_template_tr = rendered.find("tr:last").clone(true);
      if(_.has(sample_obj, '_id')) { rendered.find("#sample_create").text("Update");}
      rendered.find(".fa-plus").parent().on("click", function(){ $(this).closest("tr").after(param_template_tr.clone(true))});
      rendered.find(".fa-trash").parent().on("click", function(){ $(this).closest("tr").remove(); });
      rendered.find("#sample_create").on("click", function(e) {
        e.preventDefault();
        var formObj = $("#samples_tab").find("#mdl_holder").find("form");
        var validations = [
          [function() { return $.trim(formObj.find(".sample_name").val()) == ""; }, "Sample name cannot be blank."],
          [function() { return !/^[\w/_-]+$/.test($.trim(formObj.find(".sample_name").val())); }, "Please restrict sample names to alphanumeric characters, dashes, slashes and underscores."],
          [function() { return $.trim(formObj.find(".sample_description").val()) == ""; }, "Sample description cannot be blank."],
          [function() { return formObj.find("tbody tr.arbkv").map(function() { return $(this).find("input.cp_key").val() != "" && !/^[/\w_-]+$/.test($(this).find("input.cp_arb").val()); }).toArray().reduce(function(a, b) { return a + b; }, 0); }, "Please restrict param names to alphanumeric characters, dashes, slashes and underscores."],
          [function() { return formObj.find("tbody tr.arbkv").map(function() { return $(this).find("input.cp_key").val() != "" && $(this).find("input.cp_value").val() == ""; }).toArray().reduce(function(a, b) { return a + b; }, 0); }, "Every param that has a name must have a value and vice versa."],
          [function() { return _.some(formObj.find("[ss_validate='int']"), function(x){ return $(x).val().length > 0 && !/^[-+]?[0-9]+$/.test($(x).val())})}, $(_.find(formObj.find("[ss_validate='int']"), function(x){ return $(x).val().length > 0 && !/^[-+]?[0-9]+$/.test($(x).val())})).closest("tr").find(".cp_key").text() + " does not seem to be an int."],
          [function() { return _.some(formObj.find("[ss_validate='float']"), function(x){ return $(x).val().length > 0 && !/^[-+]?[0-9]*\.?[0-9]+$/.test($(x).val())})}, $(_.find(formObj.find("[ss_validate='float']"), function(x){ return $(x).val().length > 0 && !/^[-+]?[0-9]*\.?[0-9]+$/.test($(x).val())})).closest("tr").find(".cp_key").text() + " does not seem to be an float."],
          [function() { return _.some(formObj.find(".cp_required"), function(x){ return $(x).val().length <= 0})}, "The required parameter " + $(_.find(formObj.find(".cp_required"), function(x){ return $(x).val().length <= 0})).closest("tr").find(".cp_key").text() + " was not specified." ],
          ];
        // Various validations
        var v_failed = false;
        _.each(validations, function(validation, i) {
          console.log("Trying validation " + i + "" + validation[1]);
          if(validation[0]()) {
              error_message(validation[1]);
              v_failed = true;
              return false;
          }
        });
        if (v_failed) { e.preventDefault(); return; }
        var sample_name = $.trim(formObj.find(".sample_name").val());
        var sample_id_original = $.trim(formObj.find(".sample_id").val());
        console.log("_id:" + sample_id_original);
        let sample_params = {};
        _.each(formObj.find("[data-param-name]"), function(s){
            let key = $(s).attr("data-param-name"), r = $(s).closest("tr"), typ = $(r).find("[ss_validate]").attr("ss_validate");
            switch(typ){
                case 'bool': sample_params[key] = $(r).find(".cp_value").is(':checked'); break;
                case 'int': if($(r).find(".cp_value").val().length > 0) { sample_params[key] = _.toInteger($(r).find(".cp_value").val()) }; break;
                case 'float': if($(r).find(".cp_value").val().length > 0) { sample_params[key] = _.toNumber($(r).find(".cp_value").val()) }; break;
                case 'enum': if($(r).find(".cp_value").val().length > 0) { sample_params[key] = $(r).find(".cp_value").val()}; break;
                case 'string': if($(r).find(".cp_value").val().length > 0) { sample_params[key] = $(r).find(".cp_value").val()}; break;
            }
        });
        _.each(formObj.find("tr.arbkv"), function(r){
            let key = $(r).find(".cp_key").val(), val = $(r).find(".cp_value").val();
            if(key.length > 0 && val.length > 0) { sample_params[key] = val; }
        });
        console.log(sample_params);
        var new_sample_doc = {
          name: sample_name,
          description: $.trim(formObj.find(".sample_description").val()),
          params: sample_params
        };
        if( !_.isNil(sample_id_original) && $.trim(formObj.find(".sample_id").val()).length > 1 ) { new_sample_doc["_id"] = sample_id_original }
        if(_.isEmpty(sample_id_original) && formObj.find(".create_run").is(':checked')) { new_sample_doc["create_associated_run"] = true; }
        console.log(new_sample_doc);
        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: "ws/create_update_sample"+ "?sample_name=" + encodeURIComponent(sample_name),
          data: JSON.stringify(new_sample_doc),
          dataType: "json"
        })
        .done(function(data, textStatus, jqXHR) {
          if(data.success) {
              console.log("Successfully processed sample " + sample_name);
              $("#samples_tab").find("#mdl_holder").find(".edit_modal").modal("hide");
              window.location.reload(true);
          } else {
            alert("Server side exception processing sample " + data.errormsg);
          }
        })
        .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure processing sample " + textStatus); })
      });

      $("#samples_tab").find("#mdl_holder").append(rendered);
      $("#samples_tab").find("#mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#samples_tab").find("#mdl_holder").empty(); });
      $("#samples_tab").find("#mdl_holder").find(".edit_modal").modal("show");
    })
  }
  var clone_sample = function(existing_sample_name) {
      $.ajax("../../static/html/ms/gen_clone.html")
      .done(function(tmpl){
          Mustache.parse(tmpl);
          var rendered = $(Mustache.render(tmpl, {object_type: "sample", title: "Clone " + existing_sample_name, existing_object_name: existing_sample_name, btnlbl: "Clone"}));
          rendered.find("#obj_clone_btn").on("click", function(e){
              console.log("Cloning");
              e.preventDefault();
              var formObj = $("#samples_tab").find("#mdl_holder").find("form");
              var validations = [
                  [function() { return $.trim(formObj.find(".new_object_name").val()) == ""; }, "Sample name cannot be blank."],
                  [function() { return !/^[\w/_-]+$/.test($.trim(formObj.find(".new_object_name").val())); }, "Please restrict sample names to alphanumeric characters, dashes, slashes and underscores."],
                  [function() { return _.find($("#samples_tab").data("samples").value, function(shf){return shf.name == $.trim(formObj.find(".new_object_name").val())}) != undefined }, "The sample name already exists."]
              ];
              // Various validations
              var v_failed = false;
              _.each(validations, function(validation, i) {
                  console.log("Trying validation " + i + "" + validation[1]);
                  if(validation[0]()) {
                      error_message(validation[1]);
                      v_failed = true;
                      return false;
                  }
              });
              if (v_failed) { e.preventDefault(); return; }
              var sample_name = $.trim(formObj.find(".new_object_name").val());
              $.getJSON("ws/clone_sample"+ "?existing_sample_name=" + encodeURIComponent(existing_sample_name) + "&new_sample_name=" + encodeURIComponent($.trim(formObj.find(".new_object_name").val())))
              .done(function(data, textStatus, jqXHR) {
                  if(data.success) {
                      console.log("Successfully cloned sample " + sample_name);
                      $("#samples_tab").find("#mdl_holder").find(".edit_modal").modal("hide");
                      window.location.reload(true);
                  } else {
                      alert("Server side exception cloning sample " + data.errormsg);
                  }
              })
              .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure cloning sample " + textStatus); })
          });
          $("#samples_tab").find("#mdl_holder").append(rendered);
          $("#samples_tab").find("#mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#samples_tab").find("#mdl_holder").empty(); });
          $("#samples_tab").find("#mdl_holder").find(".edit_modal").modal("show");
      });
  }

  var delete_sample = function(sample_obj) {
    $.when($.getJSON("ws/runs", {"sampleName": sample_obj["name"], "includeParams": "false"}), $.ajax("../../static/html/ms/generic_msg.html"))
    .done(function(d0, d1) {
        let show_error = function(title, message) {
            let rendered = Mustache.render(msg_tmpl, {"title": title, "message": message});
            $("#samples_tab").find("#mdl_holder").empty().append(rendered);
            $("#samples_tab").find("#mdl_holder").find(".modal").modal("show");
        }
        let sampruns = d0[0], msg_tmpl = d1[0]; Mustache.parse(msg_tmpl);
        if(sampruns["value"].length > 0) {
            show_error("Sample " + sample_obj["name"], "Cannot delete sample " + sample_obj["name"] + " as there are " + sampruns["value"].length + " run(s) associated with it.");
            return;
        } else {
            console.log("Deleting sample " + sample_obj["name"]);
            $.getJSON({url: "ws/samples/"+encodeURIComponent(sample_obj["name"]), method: "DELETE" })
            .done(function(data){ if(data.success){ window.location.reload(true) } else { show_error("Error deleting sample", data.errormsg)}})
            .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception deleting sample " + jqXHR.responseText); })
        }
    })
  }

  $("#samples_tab").data("edit_sample", edit_sample);

  var sample_tr_tmpl = `{{#value}}<tr {{#current}}class="active_sample"{{/current}}><td><a class="smplnm" href="#">{{ name }}</a></td><td>{{ description }}</td><td>
      <span title="Display sample details"><i class="fas fa-info-circle listview-action"></i></span>
      <span title="Edit sample details" class="hide_when_locked"><i class="fas fa-edit listview-action"></i></span>
      <span title="Clone sample" class="hide_when_locked"><i class="fas fa-clone listview-action"></i></span>
      <span title="Make this sample the current sample" class="hide_when_locked">{{^current}}<span><i class="fas fa-play listview-action"></i></span>{{/current}}</span>
      <span title="Delete sample; a sample can be deleted only if there are no runs associated with it."><i class="fas fa-trash listview-action"></i></span></td></tr>{{/value}}`;
  Mustache.parse(sample_tr_tmpl);
  $.getJSON("ws/samples")
  .done(function(data){
    data.FormatDate = elog_formatdatetime;
    $("#samples_tab").data("samples", data);
    var rendered = $(Mustache.render(sample_tr_tmpl, data));
    if(is_locked){ rendered.find(".hide_when_locked").addClass("d-none") }
    rendered.find(".fa-play").parent().on("click", function(){
      var sample_name = $(this).closest("tr").find("td").first().text();
      $.getJSON({url: "ws/make_sample_current?sample_name="+encodeURIComponent(sample_name), method: "POST" })
      .done(function(data, textStatus, jqXHR) {
        if(data.success) {
            console.log("Successfully closed sample " + sample_name);
            window.location.reload(true);
        } else {
          alert("Server side exception playing sample " + sample_name + "\n" + data.errormsg);
        }
      })
      .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure closing sample " + textStatus); })
    });
    rendered.find(".fa-edit").parent().on("click", function(){
      var sample_name = $(this).closest("tr").find("td").first().text();
      $.getJSON("ws/samples/"+sample_name).done(function(data){edit_sample(data["value"]);})
    });
    rendered.find(".fa-clone").parent().on("click", function(){
        var existing_sample_name = $(this).closest("tr").find("td").first().text();
        clone_sample(existing_sample_name);
    });
    let smplinfofn = function(dis) {
        var sample_name = dis.closest("tr").find("td").first().text();
        $.getJSON("ws/samples/"+sample_name).done(function(data){display_sample(data["value"]);})
    }
    rendered.find(".fa-info-circle").parent().on("click", function(){ smplinfofn($(this)) });
    rendered.find(".smplnm").on("click", function(){ smplinfofn($(this)) });
    rendered.find(".fa-trash").parent().on("click", function(){
      var sample_name = $(this).closest("tr").find("td").first().text();
      $.getJSON("ws/samples/"+sample_name).done(function(data){delete_sample(data["value"]);})
    });
    $("#samples_tab .samplestbl tbody").append(rendered);
  });
});

$("#samples_tab").on("lg.shown.bs.tab", function() {
    var tab_toolbar = `<span id="new_sample"><i class="fas fa-plus fa-lg"></i></span>`;
    var toolbar_rendered = $(tab_toolbar);
    $("#toolbar_for_tab").append(toolbar_rendered);
    if(is_locked) { $("#toolbar_for_tab").find("#new_sample").addClass("d-none"); }
    $("#new_sample").on("click", function(e){ $("#samples_tab").data("edit_sample")({})});
});


</script>
