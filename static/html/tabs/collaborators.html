<div class="container-fluid text-center tabcontainer" id="collab_tab">
    <div id="collab_mdl_holder"></div>
    <div class="container-fluid text-center" id="collab_content">
        <div class="table-responsive">
          <table class="table table-condensed table-striped table-bordered collabtbl">
            <thead><tr><th>Id</th><th>Full Name</th><th>Permissions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
    </div>
 </div>
</div>

<script type="text/javascript">
$("#collab_tab").on("lg.loaded.bs.tab", function() {
  var collab_tr_tmpl = `{{#value}}<tr data-uid="{{ uid }}" title="{{ uidNumber }}"><td>{{#is_group}}<i class="fas fa-users" aria-hidden="true"></i>{{/is_group}}{{^is_group}}<i class="fas fa-user" aria-hidden="true"></i>{{/is_group}}{{ id }}</td><td>{{ full_name }}</td><td class="collab_admin_actions"></td></tr>{{/value}}`;
  var actions_tmpl = `<span title="{{ tooltip }}" data-role-fq-name="{{ rl }}">{{^hasrole}}<i class="fas fa-lg {{ ic }} collab-no-role" aria-hidden="true"></i>{{/hasrole}}
    {{#hasrole}}<span><i class="fas {{ ic }} fa-lg" aria-hidden="true"></i><span class="croxxout">x</span></span>{{/hasrole}}</span>`;
  Mustache.parse(collab_tr_tmpl);
  Mustache.parse(actions_tmpl);
  var refreshFunction = function() {
      $("#collab_tab .collabtbl tbody").empty();
      $.when($.getJSON("ws/collaborators"), $.getJSON("ws/has_role", {"role_fq_name": "LDAP/Admin"}))
      .done(function(d0, d1){
          var collabs = d0[0], roleAdminPerms = d1[0], hasRoleAdmin = roleAdminPerms.value.hasRole;
          _.each(collabs.value, function(c){c["id"] = _.replace(c["uid"], "uid:", "")});
          var rendered = $(Mustache.render(collab_tr_tmpl, collabs));
          $("#collab_tab .collabtbl tbody").append(rendered);
          if(hasRoleAdmin) {
              _.each(collabs.value, function(collab) {
                  _.each([["LogBook/Writer", "fa-pencil-alt", "Write/post log entries; enough for most people"], ["LogBook/Editor", "fa-edit", "Edit/change existing entries"], ["LDAP/Admin", "fa-gavel", "Add/remove collaborators"]], function(rl_ic){
                        $("tr[data-uid='" + collab["uid"] + "'] td.collab_admin_actions").append(Mustache.render(actions_tmpl, {rl : rl_ic[0], ic: rl_ic[1], hasrole: _.indexOf(collab.roles, rl_ic[0]) != -1, tooltip: rl_ic[2] }));
                  });
                  $("tr[data-uid='" + collab["uid"] + "'] td.collab_admin_actions").append($("<span class='remove-collab'><i class='fas fa-lg fa-trash' aria-hidden='true'></i></span>"));
              });
              $("span[data-role-fq-name]").on("click", function(){
                  var role_fq_name = $(this).attr("data-role-fq-name"), uid = $(this).closest("tr").attr("data-uid");
                  $.getJSON({url: "ws/toggle_role?uid=" + encodeURIComponent(uid) + "&role_fq_name=" + encodeURIComponent(role_fq_name), method: "POST"})
                  .done(function() { $("#collab_tab").data("refresh")(); })
                  .fail(function(jqXHR, textStatus, errorThrown) { console.log(jqXHR); alert("Server side exception adding/removing role " + jqXHR.responseText); })
              });
              $(".remove-collab").on("click", function() {
                  var uid = $(this).closest("tr").attr("data-uid");
                  $.getJSON({url: "ws/remove_collaborator?uid=" + encodeURIComponent(uid), method: "POST"})
                  .done(function() { $("#collab_tab").data("refresh")(); })
                  .fail(function(jqXHR, textStatus, errorThrown) { console.log(jqXHR); alert("Server side exception removing collaborator " + jqXHR.responseText); })
              })
          }
      });
  }
  $("#collab_tab").data("refresh", refreshFunction);
  refreshFunction();
});

$("#collab_tab").on("lg.shown.bs.tab", function() {
    if (!roles.is_admin) { console.log("User is not an admin; skipping actions."); return; }
    var tab_toolbar = `<span id="collab_add_user"><i class="fas fa-user fa-lg"></i></span>
    <span id="collab_add_group"><i class="fas fa-users fa-lg"></i></span>`;
    var uid_search_results = `{{#value}}<tr data-uid="{{ uid }}"><td>{{ uid }}</td><td>{{ gecos }}</td><td><input class="collab_select" type="checkbox"></td></tr>{{/value}}`;
    var group_search_results = `{{#value}}<tr data-uid="{{ . }}"><td>{{ . }}</td><td>N/A</td><td><input class="collab_select" type="checkbox"></td></tr>{{/value}}`;
    Mustache.parse(uid_search_results);
    Mustache.parse(group_search_results);
    var toolbar_rendered = $(tab_toolbar);
    $("#toolbar_for_tab").append(toolbar_rendered);
    var search_and_add = function(search_url, param_name, ms_template, uid_prefix) {
        $.ajax('../../static/html/ms/collab_search_and_add.html')
        .done(function(mdltext) {
            $("#collab_mdl_holder").append(mdltext);
            $("#collab_mdl_holder").find(".collab_search").on("input", function() {
                if($(this).val().length > 2) {
                    var search_params = {}; search_params[param_name] = $(this).val()+"*";
                    $.getJSON(search_url, search_params)
                    .done(function(data){
                        $("#collab_mdl_holder").find("tbody").empty().append(Mustache.render(ms_template, data));
                    });
                } else{
                    $("#collab_mdl_holder").find("tbody").empty();
                }
            });
            $("#collab_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){
                var add_new_collab_to_role = function(uid, role_fq_name) { return $.getJSON({url: "ws/add_collaborator?uid=" + encodeURIComponent(uid) + "&role_fq_name=" + encodeURIComponent(role_fq_name), method: "POST"}); }
                var ajax_calls = [];
                $("#collab_mdl_holder").find("tbody").find(".collab_select:checked").each(function(){var uid = uid_prefix + $(this).closest("tr").attr("data-uid"); ajax_calls.push(add_new_collab_to_role(uid, "LogBook/Writer"));});
                $.when.apply(this, ajax_calls)
                .done(function() { $(".modal-body").html(""); $("#collab_mdl_holder").empty(); $("#collab_tab").data("refresh")(); })
                .fail(function(jqXHR, textStatus, errorThrown) { console.log(jqXHR); alert("Server side exception adding collaborator " + jqXHR.responseText); })
            });
            $("#collab_mdl_holder").find(".edit_modal").modal("show");
        });
    };

    $("#collab_add_user").on("click", function(){
        search_and_add("ws/get_matching_uids", "uid", uid_search_results, "uid:");
    });
    $("#collab_add_group").on("click", function(){
        search_and_add("ws/get_matching_groups", "group_name", group_search_results, "");
    });
});
</script>
