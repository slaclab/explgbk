<div class="container-fluid text-center tabcontainer" id="elog_tab">


<div class="mdl_holder"></div>
<div class="container-fluid text-center" id="elog_content">
</div>

</div>




<script type="text/javascript">
$("#elog_tab").on("lg.loaded.bs.tab", function() {

 var elog_header = `<div class="row exp_tab_header">
  <div class="col-md-2">Posted</div>
  <div class="col-md-1">Run</div>
  <div class="col-md-5">Content</div>
  <div class="col-md-3">Tags</div>
  <div class="col-md-1">Author</div>
 </div><div class="spgntr_append"></div>`;
 var elog_main_template = `<div class="edat {{^root}}etop{{/root}}{{#root}}edesc{{/root}}" id="{{ elem_id }}" data-spgntr="{{elem_id}}"><div class="row">
  <div class="col-md-2">
    <span class="elog-expand elog-compressed exp_icons_left"><i class="fas fa-plus expand_ctrl"></i></span>
    {{#c_attach}}<span class="exp_icons_left"><i class="fas fa-paperclip expand_ctrl"></i></span>{{/c_attach}}
    {{#FormatDate}}{{ relevance_time }}{{/FormatDate}}
  </div>
  <div class="col-md-1">{{ run_num }}</div>
  {{> main_content_tmpl }}
  <div class="col-md-1">{{ author }}</div>
  </div></div>`;
  var elog_main_content_template = `<div class="col-md-5 elog_main_cnt text_truncate {{#deleted_by}}elog_deleted{{/deleted_by}} ">{{#title}}{{title}}{{/title}}{{^title}}{{ content }}{{/title}}</div><div class="col-md-3 elog_main_cnt">{{#src_expname}}{{.}}{{#tagcount}}|{{/tagcount}}{{/src_expname}}{{#tags}}<span class="elog_tag">{{.}}</span>{{/tags}}</div>`;

 var elog_child_template = `<div class="row col-md-12 elog-chid">
   <div class="card">
    <div class="card-header text-left"><span class="entry_actions">{{^deleted_by}}<span class="followup" title="Followup"><i class="fas fa-paper-plane fa-lg"></i></span>{{#privileges.edit}}<span class="edit" title="Edit"><i class="fas fa-edit fa-lg"></i></span>{{^parent}}<span class="ins_elogs" title="Post to instrument elogs"><i class="fas fa-mail-bulk fa-lg"></i></span>{{/parent}}<span class="delete" title="Delete"><i class="fas fa-trash fa-lg"></i></span>{{/privileges.edit}}{{/deleted_by}}</span>{{#title}}<div class="chid_title">{{title}}</div><div class="chid_content">{{{content}}}</div>{{/title}}{{^title}}<pre>{{content}}</pre>{{/title}}</div>
    <div class="card-body">
      {{> elog_chid_body_content }}
     <div class="row dialog_holder"></div>
    </div>
   </div>
 </div>`;
 var elog_chid_body_content = `<div class="elog_chid_body_content">{{#deleted_by}}<div class="row elog_deleted_by">Deleted by {{deleted_by}} - {{#FormatDate}}{{ deleted_time }}{{/FormatDate}}</div>{{/deleted_by}}
 <div class="row">{{#attachments}}<div class="col-xs-6 col-md-3"><a href="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=False" target="_blank" class="thumbnail"><img class="elog_img" src="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=true"></img></a></div>{{/attachments}}</div></div>`;

 var elog_followup_template = `<div class="row followup_div"><div class="card col-8"><div class="card-body">
      <form class="followup_form" role="form">
       <button type="button" class="close">&times;</button>
       <input type="hidden" name="parent" value="{{ _id }}">
       <div class="validation_warning d-none"></div>
       <div class="form-group row log_title_div d-none"><label class="col-sm-2 col-form-label text-right">Title*:</label><div class="col-sm-8"><input class="form-control log_title" type="text" name="log_title"/></div></div>
       <div class="form-group row"><label class="col-sm-2 col-form-label text-right">Text*: <span class="elog_followup_html"><i class="fas fa-table" title="HTML log entry"></i><span></label><div class="col-sm-8"><textarea class="form-control elog_followup_textarea" rows="5" name="log_text"></textarea></div></div>
       <div class="form-group row"><label class="col-sm-2 col-form-label text-right">Email:</label><select class="form-control contacts email_select" rows="10" name="log_emails_shown" placeholder="email1 email2@institution.edu" multiple></select><input class="invisible email_input" name="log_emails" value="{{ emails_str }}"></input></div>
       <div class="form-group row"><label class="col-sm-2 col-form-label text-right">Tags:</label><div class="col-sm-8"><input class="form-control" type="text" name="log_tags" placeholder="Tag1 Tag2 Tag3"/></div></div>
       <div class="form-group row files_div"><label class="col-sm-2 col-form-label text-right">File</label><div class="col-sm-8"><input type="file" class="form-control" name="files" multiple/></div></div>
       <div class="form-group row justify-content-center"><button type="button" class="btn btn-primary followup_post">Post</button></div>
      </form></div></div></div>`;

  var elog_run_main_template = `<div class="edat etop" id="{{ elem_id }}" data-spgntr="{{elem_id}}"><div class="row">
       <div class="col-md-2">
         <span class="elog-expand elog-compressed exp_icons_left"><i class="fas fa-plus expand_ctrl"></i></span>
         {{#FormatDate}}{{relevance_time}}{{/FormatDate}}
       </div>
       <div class="col-md-1">{{ num }}</div>
       <div class="elog_main_cnt col-md-5 text_truncate">{{ content }}</div>
       </div></div>`;

   var elog_run_child_template = `<div class="row col-md-12 elog-chid">
     <div class="card">
      <div class="card-body">
        {{#param_list}}
          <div class="elog_run_param_category text-left" data-category="{{k}}"><span class="expand_param expand_plus"><i class="fas fa-plus"></i></span>{{k}}<div class="elog_run_params_expanded"></div></div>
        {{/param_list}}
        {{^param_list}}<div class="text-left">This run has no params</div>{{/param_list}}
      </div>
     </div>
   </div>`;

   var elog_run_child_expanded_params_template = `<table class="table table-condensed table-striped table-bordered"><thead><tr><th>Name</th><th>Value</th><th>Description</th></tr></thead><tbody>{{#params}}<tr><td>{{k}}</td><td>{{v}}</td><td>{{d}}</td></tr>{{/params}}</tbody></table>`;


   var id2entry = {};
   var skip_websocket_elog_messages = false;

  Mustache.parse(elog_main_template);
  Mustache.parse(elog_main_content_template);
  Mustache.parse(elog_child_template);
  Mustache.parse(elog_chid_body_content);
  Mustache.parse(elog_followup_template);
  Mustache.parse(elog_run_main_template);
  Mustache.parse(elog_run_child_template);
  Mustache.parse(elog_run_child_expanded_params_template);

  var summernote_options = {toolbar: [
    // [groupName, [list of button]]
    ['para', ['ul', 'ol', 'table', 'link', 'hr', 'paragraph', 'style']],
    ['font', ['fontname', 'fontsize', 'color']],
    ['style', ['bold', 'italic', 'clear']],
    ['help', ['codeview', 'help']]
]};


  var renderMSTemplate = function(template, entry, partials) { // Convienience method to render time correctly.
    entry.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY HH:mm:ss");}};
    return $(Mustache.render(template, entry, partials));
  }

  var check_session_timeout = function() {
      if(auth_expiration_time > 1000000000 && moment.unix(auth_expiration_time).isSameOrBefore(moment().add(5, 'minutes'))) {alert("Your session is about to expire. Please log back in to renew your session."); return true; }
  }

  var email_selector = function(content_div) {
      $.getJSON(elog_emails).done(function(dat){
          var existing_emails = dat.value;
          var email_choices = _.map(existing_emails, function(em){ return {email: em}});
          var selected_items = _.split(content_div.find(".email_input").val(), " ");
          content_div.find(".email_select").selectize({persist: false, valueField: 'email', labelField: 'email', maxItems: null, options: email_choices, items: selected_items,
            render: { item: function(item, escape)   { return "<div class='selectedoption'><span>" + escape(item['email']) + "</span></div>"; },
                      option: function(item, escape) { return "<div class='seloption'><span>" + escape(item["email"]) + "</span></div>"; }
                  },
                  create: function(input) { return {email: input }}});
          content_div.find(".email_select").on("change", function() {
              content_div.find(".email_input").val(_.join(content_div.find(".email_select").val(), " "));
          })
      });
  }

 var followup_function = function() {
    if($(this).closest(".edat").find(".followup_div").length > 0) { $(this).closest(".edat").find(".followup_div").remove(); return; }
    if(check_session_timeout()) return;
	var entry = $(this).closest(".edat").data("entry"), current_text_mode_html = false;
	var rendered = renderMSTemplate(elog_followup_template, entry);
    email_selector(rendered);
	rendered.find(".close").on("click", function(){ $(this).closest(".followup_div").remove(); });
    rendered.find(".elog_followup_html").on("click", function(){ $(this).closest(".followup_div").find(".log_title_div").removeClass("d-none"); $(this).closest(".followup_div").find("textarea").summernote(summernote_options); current_text_mode_html=true; $(this).remove(); });
	rendered.find(".followup_post").on("click", function(){
        var val_alert = function(th, msg) { th.closest(".followup_form").find(".validation_warning").html("Please enter a title for the log message").removeClass("d-none"); return false;  }
        if(current_text_mode_html) {
            if(_.isEmpty($.trim($(this).closest(".followup_form").find(".log_title").val()))) { return val_alert($(this), "Please enter a title for the log message"); }
            if(_.isEmpty($.trim($($(this).closest(".followup_form").find("textarea").val()).text()))) { return val_alert($(this), "Please enter some text for the log message"); }
        } else {
            if(_.isEmpty($.trim($(this).closest(".followup_form").find("textarea").val()))) { return val_alert($(this), "Please enter some text for the log message");}
        }
        if($(this).closest(".followup_form").find(".files_div").find("[name='files']")[0].files.length <= 0) { console.log("No files specified; removing control to cater to Safari."); $(this).closest(".followup_form").find(".files_div").remove(); }
		var formData = new FormData(rendered.find(".followup_form")[0]);
		$.ajax({
			url: 'ws/new_elog_entry',
			data: formData,
			type: 'POST',
			contentType: false, // Needed
			processData: false // Needed
		})
		.done(function(data, textStatus, jqXHR) {
			if(data.success) {
				console.log("Successfully posted follow elog entry");
			} else {
				alert("Server side exception posting followup elog entry " + data.errormsg);
			}
		})
		.fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception posting followup elog entry " + jqXHR.responseText); })
		$(this).closest(".followup_div").remove();
	});

	$(this).closest(".elog-chid").find(".dialog_holder").first().html(rendered);
 }

 var edit_elog_entry = function() {
    if($(this).closest(".edat").find(".followup_div").length > 0) { $(this).closest(".edat").find(".followup_div").remove(); return; }
    if(check_session_timeout()) return;
    var entry = $(this).closest(".edat").data("entry"), current_text_mode_html = false;
    var rendered = renderMSTemplate(elog_followup_template, entry);
    email_selector(rendered);
 	rendered.find(".close").on("click", function(){ $(this).closest(".followup_div").remove(); });
    rendered.find("textarea").first().text(entry["content"]);
    if(_.has(entry, "title")) {
        current_text_mode_html = true;
        rendered.find(".log_title").val(entry["title"]);
        rendered.find(".log_title_div").removeClass("hidden");
        rendered.find(".elog_followup_html").remove();
        rendered.find("textarea").first().summernote(summernote_options);
    } else {
        rendered.find(".elog_followup_html").on("click", function() { $(this).closest(".followup_div").find(".log_title_div").removeClass("hidden"); $(this).closest(".followup_div").find("textarea").summernote(summernote_options); current_text_mode_html=true; $(this).remove(); });
    }
    rendered.find("input[name='log_tags']").val(_.join(_.get(entry, "tags", []), " "));
 	rendered.find(".followup_post").on("click", function(){
        if(current_text_mode_html) {
            if(_.isEmpty($.trim($(this).closest(".followup_form").find(".log_title").val()))) { $(this).closest(".followup_form").find(".validation_warning").html("Please enter a title for the log message"); return false; }
            if(_.isEmpty($.trim($($(this).closest(".followup_form").find("textarea").val()).text()))) { $(this).closest(".followup_form").find(".validation_warning").html("Please enter some text for the log message"); return false; }
        } else {
            if(_.isEmpty($.trim($(this).closest(".followup_form").find("textarea").val()))) { $(this).closest(".followup_form").find(".validation_warning").html("Please enter some text for the log message"); return false; }
        }
        if($(this).closest(".followup_form").find(".files_div").find("[name='files']")[0].files.length <= 0) { console.log("No files specified; removing control to cater to Safari."); $(this).closest(".followup_form").find(".files_div").remove(); }
 		var formData = new FormData(rendered.find(".followup_form")[0]);
 		$.ajax({
 			url: 'ws/modify_elog_entry?_id='+encodeURIComponent(entry["_id"]),
 			data: formData,
 			type: 'POST',
 			contentType: false, // Needed
 			processData: false // Needed
 		})
 		.done(function(data, textStatus, jqXHR) {
 			if(data.success) {
 				console.log("Successfully edited elog entry");
 			} else {
 				alert("Server side exception editing elog entry " + data.errormsg);
 			}
 		})
 		.fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception editing elog entry " + jqXHR.responseText); })
 		$(this).closest(".followup_div").remove();
 	});
    $(this).closest(".elog-chid").find(".dialog_holder").html(rendered);
 }

 var delete_elog_entry = function() {
     var entry = $(this).closest(".edat").data("entry");
     $.getJSON({url: "ws/delete_elog_entry?_id="+encodeURIComponent(entry["_id"]), method: "DELETE" })
     .done(function(){})
     .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception deleting elog entry " + jqXHR.responseText); })
 }

 var post_to_instrument_elogs = function() {
     var entry = $(this).closest(".edat").data("entry");
     $.when($.ajax('../../static/html/ms/choose_few_of_many.html'), $.getJSON("ws/get_instrument_elogs")).done(function(d0, d1){
         var instrument_elogs = d1[0].value, choose_tmpl = d0[0]; Mustache.parse(choose_tmpl);
         if(_.isEmpty(instrument_elogs)) { alert("There are no elogs configured for this instrument."); return; }
         instrument_elogs = _.difference(instrument_elogs, _.get(entry, "post_to_elogs", []));
         if(_.isEmpty(instrument_elogs)) { alert("All related elogs seem to have this entry"); return; }
         var rendered = renderMSTemplate(choose_tmpl, { title: "Cross-post this entry to these related elogs", submit_label: "Post", choices: instrument_elogs });
         rendered.find(".c_f_o_m_submit").on("click", function(){
             var post_to_elogs = $("#elog_tab").find(".mdl_holder").find(".modal").find("input:checked").map(function() { return $(this).attr("name"); }).toArray();
             console.log(post_to_elogs);
             $("#elog_tab").find(".mdl_holder").find(".modal").modal("hide");
             if(!_.isEmpty(post_to_elogs)) {
                 $.getJSON({url: "ws/cross_post_elogs", data: {_id: entry["_id"], post_to_elogs: _.join(post_to_elogs, ",") }})
                 .done(function(){})
                 .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception cross posting elog entry " + jqXHR.responseText); })
             }
         })
         $("#elog_tab").find(".mdl_holder").append(rendered);
         $("#elog_tab").find(".mdl_holder").find(".modal").on("hidden.bs.modal", function(){ $("#elog_tab").find(".mdl_holder").empty(); });
         $("#elog_tab").find(".mdl_holder").find(".modal").modal();
     })
 }

 var expandFunction = function() {
	var entry = $(this).closest(".edat").data("entry");
	console.log("Expand/contract " + entry["_id"]);
	if($(this).hasClass("elog-expanded")) {
		$(this).closest(".edat").find(".elog-chid").remove();
    	$(this).html('<i class="fas fa-plus expand_ctrl"></i>');
	} else {
		var clicked_elem = $(this);
        entry.privileges = privileges;
	    clicked_elem.closest(".edat").append(renderMSTemplate(elog_child_template, entry, { elog_chid_body_content: elog_chid_body_content } ));
	    clicked_elem.closest(".edat").find(".followup").on("click", followup_function);
        clicked_elem.closest(".edat").find(".delete").on("click", delete_elog_entry);
        clicked_elem.closest(".edat").find(".edit").on("click", edit_elog_entry);
        clicked_elem.closest(".edat").find(".ins_elogs").on("click", post_to_instrument_elogs);
		_.each(_.sortBy(_.map(entry["c_children"], function(chid) { return $("#elog_tab").data("entries")[chid]; }), function(s) { return s["relevance_time"]; }).reverse(), function(ch_entry) {
		    var rendered = renderMSTemplate(elog_main_template, ch_entry, { main_content_tmpl: elog_main_content_template });
		    rendered.data("entry", ch_entry).data("ts", moment(ch_entry["relevance_time"]));
		    clicked_elem.closest(".edat").find(".card-body").append(rendered);
		    rendered.find(".elog-expand").on("click", expandFunction);
		});
    	$(this).html('<i class="fas fa-minus expand_ctrl"></i>');
	}
	$(this).toggleClass("elog-expanded elog-compressed");
 };

 var runExpandFunction = function() {
     var entry = $(this).closest(".edat").data("entry");
     console.log("Expand/contract run " + entry["num"]);
     if($(this).hasClass("elog-expanded")) {
         $(this).closest(".edat").find(".elog-chid").remove();
         $(this).html('<i class="fas fa-plus expand_ctrl"></i>');
     } else {
         var clicked_elem = $(this);
         $.getJSON("ws/run_table_sources")
         .done(function(param_defs) {
             // src2catdesc is a flattened dict of arrays of dicts into a dict indexed by the source attribute.
             var src2catdesc = _.fromPairs(_.map(_.flatten(_.concat(_.values(param_defs.value))), function(pd) { return [_.replace(pd['source'], "params.", ""), { category: pd['category'], description: pd['description']}]})), categorized_params = {};
             _.each(entry["params"], function(v, k){
                 var category = _.get(src2catdesc, k + ".category", "Misc"), desc = _.get(src2catdesc, k + ".description", "N/A");
                 _.defaults(categorized_params, _.fromPairs([[category,[]]]))[category].push({k: k, v: v, d: desc});
             })
             var cat_params_list = _.sortBy(_.map(categorized_params, function(v, k){ return {k: k, v: v}}), function(o){return o['k']});
             var rendered = renderMSTemplate(elog_run_child_template, { param_list: cat_params_list });
             rendered.find(".expand_param").on("click", function(){
                 var clickedElem = $(this).closest(".elog_run_param_category");
                 if($(this).hasClass("expand_plus")) {
                     var paramsrendered = renderMSTemplate(elog_run_child_expanded_params_template, { params: _.sortBy(categorized_params[clickedElem.attr("data-category")], function(o){ return o['k']})});
                     clickedElem.find(".elog_run_params_expanded").append(paramsrendered);
                     $(this).find("svg").replaceWith($('<i class="fas fa-minus"></i>'));
                 } else {
                     clickedElem.find(".elog_run_params_expanded").empty();
                     $(this).find("svg").replaceWith($('<i class="fas fa-plus"></i>'));
                 }
                 $(this).toggleClass("expand_plus")
             });
             clicked_elem.closest(".edat").append(rendered);
             $(this).html('<i class="fas fa-minus expand_ctrl"></i>');
         });
     }
     $(this).toggleClass("elog-expanded elog-compressed");
 };

  var replaceExistingElogEntryContent = function(existingElem) { // If we get a update for an edit over web socker, we replace the contents of the elog entry.
      existingElem.find(".elog_main_cnt").replaceWith(renderMSTemplate(elog_main_content_template, this));
      if(_.has(this, "title")) {
          window.jaja = existingElem; window.jajaobj = this;
          existingElem.find(".elog-chid").first().find(".chid_title").text(this["title"]);
          existingElem.find(".elog-chid").first().find(".chid_content").html($(this["content"]));
      } else {
          existingElem.find(".elog-chid pre").first().text(this["content"]);
      }
      existingElem.find(".elog_chid_body_content").first().replaceWith(renderMSTemplate(elog_chid_body_content, this));
  }

  var elogEntryRenderFunction = function() {
      var rendered = renderMSTemplate(elog_main_template, this, { main_content_tmpl: elog_main_content_template })
      rendered.data("entry", this).data("ts", moment(this["relevance_time"]));
      rendered.find(".elog-expand").on("click", this.expandFunction);
      return rendered;
  }

  var runRenderFunction = function() {
      var rendered = renderMSTemplate(elog_run_main_template, this);
      rendered.data("entry", this).data("ts", moment(this["relevance_time"]));
      rendered.find(".elog-expand").on("click", this.expandFunction);
      return rendered;
  }

  var processElogEntry = function(entry) {
	  var root = _.get(entry, "root", null), parent = _.get(entry, "parent", null), attachments = _.get(entry, "attachments", null);
      if(attachments != null) {
    	  entry["c_attach"] = true;
    	  _.each(attachments, function(attachment) { attachment["entry_id"] = entry["_id"]; });
      }
      entry.render = elogEntryRenderFunction;
      entry.replaceExistingElogEntryContent = replaceExistingElogEntryContent;
      entry.expandFunction = expandFunction;
      entry.tagcount = _.get(entry, "tags", []).length;
      entry["elem_id"] = entry["_id"];
      entry["r_time"] = (new Date(entry["relevance_time"])).getTime();
      entry["emails_str"] = _.join(_.get(entry, "email_to", []), " ");
      id2entry[entry["_id"]] = entry;
  }

  var attach_children = function() {
      _.each(id2entry, function(entry, key){
          var myid = entry["_id"], root = _.get(entry, "root", null), parent = _.get(entry, "parent", null);
          if(parent != null && _.has(id2entry, parent)) {
        	  var pey = id2entry[parent];
       		  _.defaults(pey, {"c_children": []});
       		  pey["c_children"] = _.union(pey["c_children"], [ entry["_id"] ]);
          }
          if(root != null && _.has(id2entry, root)) {
        	  var rey = id2entry[root];
       		  _.defaults(rey, {"c_desc": []});
       		  rey["c_desc"] = _.union(rey["c_desc"], [ entry["_id"] ]);
          }
      });
  }

  $("#elog_tab").data("entries", id2entry);

  var processElogResponse = function(data) {
    _.each(data.value, function(entry) { processElogEntry(entry); });
    attach_children();
    return data.value;
  };

  var processRunResponse = function(data) {
      var runEntries = [];
      var addRunEntry = function(run, run_end) { // If run_end is true; we insert a stop event.
          var runData = _.clone(run);
          runData["elem_id"] = "r_"+runData["_id"]+ (run_end==true ? "_e" : "_b");
          runData["relevance_time"] = (run_end==true ? runData['end_time'] : runData['begin_time']);
          runData["r_time"] = (new Date(runData["relevance_time"])).getTime();
          runData["content"] = (run_end==true ? "Stop" : "Start");
          runData.render = runRenderFunction;
          runData.replaceExistingElogEntryContent = function() {};
          runData.expandFunction = runExpandFunction;
          runEntries.push(runData);
      }
      _.each(data.value, function(runData) {
          addRunEntry(runData, false);
          if (_.get(runData, "end_time", null) != null) { addRunEntry(runData, true) };
      });
      return runEntries;
  }

  var renderElogResponse = function(data) {
      $("#elog_content").html(elog_header);
      sortable_paginator($("#elog_content"), "elem_id", "r_time", true, 0, 100, 100);
      $("#elog_content").data("spgntr").addObjects(_.filter(data.value, function(f) { return !_.has(f, "root") }));
  }

  $(window).scroll(function () {
      if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {
          $("#elog_content").data("spgntr").pageDown();
      }
  });


  var load_elog_function = function() {
      var user_specified_log_entry_id = getURLParameter("_id");
      if(!_.isNil(user_specified_log_entry_id)) {
          console.log("Loading elog for specific entry " + user_specified_log_entry_id);
          $.getJSON({ url: "ws/search_elog", data: { "_id": user_specified_log_entry_id }}).done(function(data){
              processElogResponse(data);
              renderElogResponse(data);
              _.times(100, function(){ $(".elog-compressed").trigger("click"); });
              skip_websocket_elog_messages = true;
          });
      } else {
          var elog_params = {};
          if(sample_showing_in_UI != null && sample_showing_in_UI != "All Samples") { elog_params["sampleName"] = sample_showing_in_UI; }
          $.when($.getJSON("ws/elog", elog_params), $.getJSON("ws/runs", elog_params))
          .done(function(d1, d2){
              var elogData = d1[0], runData = d2[0];
              skip_websocket_elog_messages = false;
              renderElogResponse({value: _.concat(processElogResponse(elogData), processRunResponse(runData))});
          });
      }
  };
  $("#elog_tab").data("refresh", load_elog_function);
  $("#elog_tab").on("lg.refresh", function() { load_elog_function(); });

  load_elog_function();

  $(document).on('elog', function(event, elogEvent) {
      if(skip_websocket_elog_messages) { console.log("Skipping elog message from server."); return; }
      var elogData = elogEvent.value;
      console.log("Processing elog event for experiment " + experiment_name + " id=" + elogData["_id"]);
      if(_.has(elogData, "sample") && sample_showing_in_UI != null && sample_showing_in_UI != "All Samples" && elogData['sample'] != sample_showing_in_UI) { console.log("Skipping updating elog for different sample " + elogData['sample']); return; }
      processElogEntry(elogData);
      attach_children();
      console.log(elogData);
      if(!_.has(elogData, "root")) {
          $("#elog_content").data("spgntr").addObject(elogData);
      } else {
          console.log("Child row of " + elogData["parent"]);
          let entryinserted = false, newentrydt = moment(elogData['relevance_time']);
          $.each($("#"+elogData["parent"]).find(".edat"), function() {
              if(!entryinserted) {
                  var existing_entry = $(this).data("entry");
                  var existing_entry_dt = moment(existing_entry['relevance_time']);
                  if (newentrydt.isAfter(existing_entry_dt)) {
                      $(this).before(elogData.render());
                      entryinserted = true;
                  }
              }
            });
            if(!entryinserted) {
                console.log("Inserting possible first child entry");
                $("#"+elogData["parent"]).find(".card-body").append(elogData.render());
                entryinserted = true;
            }
      }
  });

  $(document).on('runs', function(event, runEvent) {
      if(skip_websocket_elog_messages) { console.log("Skipping run message from server."); return; }
      var runData = runEvent.value;
      console.log("Processing run event for experiment " + experiment_name + " id=" + runData["num"]);
      if(_.has(runData, "sample") && sample_showing_in_UI != null && sample_showing_in_UI != "All Samples" && runData['sample'] != sample_showing_in_UI) { console.log("Skipping updating elog runs for different sample " + runData['sample']); return; }
      var newRunEntries = processRunResponse({value: [runData]});
      _.each(newRunEntries, function(r){$("#elog_content").data("spgntr").addObject(r)});
  });


  $("#elog_tab").data("new_entry_click", function(e) {
     if(check_session_timeout()) return;
	 e.preventDefault();
     $.when($.ajax('../../static/html/tabs/elog_new_entry.html'), $.getJSON(current_run_url), $.getJSON("ws/get_instrument_elogs"))
     .done(function(modal_txt, cur_run, inselgsresp){
         var current_run_num =_.get(cur_run[0], "value.num", ""), ins_elogs = inselgsresp[0].value, mdl = $(Mustache.render(modal_txt[0], { current_run_num: current_run_num, post_to_instrument_elogs: (ins_elogs.length > 0), instrument_elogs: ins_elogs })), current_text_mode_html=false;
         $("#elog_content").prepend(mdl);
         email_selector($("#elog_content"));
         $("#elog_content").find(".elog_html").on("click", function(){ $("#elog_content").find(".log_title_div").removeClass("d-none"); $(this).remove(); $('#elog_new_entry_log_text').summernote(summernote_options); current_text_mode_html=true;});
         $("#elog_new_entry_modal_post").on("click", function (e) {
            var formData = new FormData($('#elog_new_entry_form')[0]);
            if(current_text_mode_html) {
                if(_.isEmpty($.trim($("#elog_new_entry_log_title").val()))) { $("#elog_new_entry_modal").find(".validation_warning").html("Please enter a title for the log message"); return false; }
                if(_.isEmpty($.trim($($("#elog_new_entry_log_text").val()).text()))) { $("#elog_new_entry_modal").find(".validation_warning").html("Please enter some text for the log message"); return false; }
            } else {
                if(_.isEmpty($.trim($("#elog_new_entry_log_text").val()))) { $("#elog_new_entry_modal").find(".validation_warning").html("Please enter some text for the log message"); return false; }
            }
            if($('#elog_new_entry_form').find(".files_div").find("[name='files']")[0].files.length <= 0) { console.log("No files specified; removing control to cater to Safari."); $('#elog_new_entry_form').find(".files_div").remove(); }
            $.ajax({
                  url: 'ws/new_elog_entry',
                  data: formData,
                  type: 'POST',
                  contentType: false, // Needed
                  processData: false // Needed
              })
              .done(function(data, textStatus, jqXHR) {
                  if(data.success) {
                      console.log("Successfully posted elog entry");
                  } else {
                      alert("Server side exception posting new elog entry " + data.errormsg);
                  }
              })
              .fail(function(jqXHR, textStatus, errorThrown) { console.log(jqXHR); alert("Server side exception posting new elog entry " + jqXHR.responseText); })
            $("#elog_new_entry_modal").modal("hide");
         });
         $("#elog_new_entry_modal").modal();
     });
 });



  $("#elog_tab").data("search_text_input", function(e) {
      var search_text = $("#elog_search_text").val();
      if (!_.isNil(search_text)) {
          if(/^[0-9]+$/g.test(search_text)) {
              $.getJSON({ url: "ws/search_elog", data: { run_num : search_text }}).done(function(data){ skip_websocket_elog_messages = true; processElogResponse(data); renderElogResponse(data); });
          } else if(/^([0-9]+)-([0-9]+)$/g.test(search_text)) {
              var start_run_num = /^([0-9]+)-([0-9]+)$/g.exec(search_text)[1];
              var end_run_num   = /^([0-9]+)-([0-9]+)$/g.exec(search_text)[2];
              $.getJSON({ url: "ws/search_elog", data: { start_run_num : start_run_num, end_run_num: end_run_num }}).done(function(data){ skip_websocket_elog_messages = true; processElogResponse(data); renderElogResponse(data); });
          } else if(/^\d{1,2}[\/.]\d{1,2}[\/.]\d{4}$/.test(search_text) && moment(search_text, "MM/DD/YYYY").isValid()) {
              $.getJSON({ url: "ws/search_elog", data: { start_date : moment(search_text, "MM/DD/YYYY").subtract(1, "days").toJSON(), end_date : moment(search_text, "MM/DD/YYYY").add(1, "days").toJSON() }}).done(function(data){ skip_websocket_elog_messages = true; processElogResponse(data); renderElogResponse(data); });
          } else if(/^\d{1,2}[\/.]\d{1,2}[\/.]\d{4}-\d{1,2}[\/.]\d{1,2}[\/.]\d{4}$/.test(search_text) && moment(_.split(search_text, "-")[0], "MM/DD/YYYY").isValid() && moment(_.split(search_text, "-")[1], "MM/DD/YYYY").isValid()) {
              $.getJSON({ url: "ws/search_elog", data: { start_date : moment(_.split(search_text, "-")[0], "MM/DD/YYYY").subtract(1, "days").toJSON(), end_date : moment(_.split(search_text, "-")[1], "MM/DD/YYYY").add(1, "days").toJSON() }}).done(function(data){ skip_websocket_elog_messages = true; processElogResponse(data); renderElogResponse(data); });
          } else if(search_text.length > 2) {
              $.getJSON({ url: "ws/search_elog", data: { search_text : search_text }}).done(function(data){ skip_websocket_elog_messages = true; processElogResponse(data); renderElogResponse(data); });
          } else {
              $("#elog_tab").data("refresh")();
          }
      } else {
          $("#elog_tab").data("refresh")();
      }
  });

  $("#elog_tab").data("elog_attachments_only", function() {
      console.log("Getting data for attachments only");
      $.getJSON("ws/elog")
      .done(function(data){
          var attachments_only_template = `<div class="row elog_attachments_only">{{#attachments}}<div class="col-xs-6 col-md-3"><a href="?_id={{entry_id}}#eLog" class="thumbnail"><img class="elog_img" src="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=true"></img></a></div>{{/attachments}}</div>`;
          Mustache.parse(attachments_only_template);
          var attachments_flat_list = [];
          _.each(data.value, function(entry) {
              if(_.has(entry, 'attachments')) {
                  _.each(entry.attachments, function(attachment){
                      attachment["entry_id"] = entry["_id"];
                      attachments_flat_list.push(attachment);
                  });
              }
          });
          var rendered = Mustache.render(attachments_only_template, { attachments: attachments_flat_list.reverse()});
          $("#elog_content").html(rendered);
      });
  });

});

$("#elog_tab").on("lg.shown.bs.tab", function() {
    var tab_toolbar = `<input type="text" placeholder="Search/Run etc - see tooltip" title="Search;Author;Tag;Run;Run-Run;date(MM/DD/YYYY);date-date" id="elog_search_text">
    <span id="elog_new_entry"><i class="fas fa-plus fa-lg" title="Post a new elog entry"></i></span>
    <span id="elog_attachments_only"><i class="fas fa-paperclip fa-lg" title="Toggle attachments only"></i></span>
    <span id="elog_deleted_entries"><i class="fas fa-strikethrough fa-lg" title="Toggle deleted entries"></i></span>
    <span id="elog_email_subscribe"><i class="fas fa-envelope-open fa-lg" title="Email subscription"></i></span>`;
    var toolbar_rendered = $(tab_toolbar);
    $("#toolbar_for_tab").append(toolbar_rendered);
    $("#elog_new_entry").on("click", $("#elog_tab").data("new_entry_click"));
    $("#elog_attachments_only").on("click", function() {
        if($("#elog_attachments_only").hasClass("pushedin")) {
            $("#elog_tab").data("refresh")();
            skip_websocket_elog_messages = false;
        } else {
            $("#elog_tab").data("elog_attachments_only")();
            skip_websocket_elog_messages = true;
        }
        $("#elog_attachments_only").toggleClass("pushedin");
    });
    $("#elog_deleted_entries").on("click", function() {
        if($("#elog_deleted_entries").hasClass("pushedin")) {
            $("#elog_tab").find(".elog_deleted").closest(".edat").removeClass("d-none");
        } else {
            $("#elog_tab").find(".elog_deleted").closest(".edat").addClass("d-none");
        }
        $("#elog_deleted_entries").toggleClass("pushedin");
    });
    $("#elog_email_subscribe").on("click", function(){
        $.when($.ajax('../../static/html/ms/elog_email_subscriptions.html'), $.getJSON("ws/elog_email_subscriptions"))
        .done(function(mdltxt, emls){
            var email_subscription_modal = mdltxt[0], email_subscribers = emls[0].value, current_user_subscription = _.find(email_subscribers, ['subscriber', logged_in_user]);
            Mustache.parse(email_subscription_modal);
            var rendered = $(Mustache.render(email_subscription_modal, {experiment_name: experiment_name, logged_in_user: logged_in_user, current_user_subscription: current_user_subscription, email_subscribers: email_subscribers}));
            $("#elog_content").prepend(rendered);
            $('#elog_email_subscriptions').on('hidden.bs.modal', function () { $('#elog_email_subscriptions').remove(); });
            $('#elog_email_subscriptions_subscribe').on("click", function(){ $.getJSON("ws/elog_email_subscribe").done(function(){$('#elog_email_subscriptions').find(".elog_email_subscription_msg").toggleClass("d-none")})});
            $('#elog_email_subscriptions_unsubscribe').on("click", function(){ $.getJSON("ws/elog_email_unsubscribe").done(function(){$('#elog_email_subscriptions').find(".elog_email_subscription_msg").toggleClass("d-none")})});
            $("#elog_email_subscriptions").modal();
        })
    });
    $("#elog_search_text").on("input", $("#elog_tab").data("search_text_input"));
});

</script>
