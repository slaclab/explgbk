<div class="container-fluid text-center tabcontainer" id="elog_tab">
<div id="elog_new_entry_modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <div class="modal-header">
                <h4 class="modal-title">Post new eLog entry</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" role="form" id="elog_new_entry_form">
                    <div class="form-group">
                        <label  class="col-sm-2 control-label" for="elog_new_entry_run_num" title="Specify an optional run number">Run</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" name="run_num" id="elog_new_entry_run_num"/>
                        </div>
                    </div>
                    <div class="validation_warning"></div>
                    <div class="form-group">
                        <label  class="col-sm-2 control-label" for="elog_new_entry_log_text">Text*</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="5" name="log_text" id="elog_new_entry_log_text"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="elog_new_entry_email_dest" title="Email this log entry to folks specified in this list:">Email:</label>
                        <div class="col-sm-4">
                            <input class="form-control" rows="5" name="log_emails" id="elog_new_entry_email_dest" placeholder="email1 email2@institution.edu"></input>
                        </div>
                        <!--label class="col-sm-2 control-label" for="elog_new_entry_tags" title="Enter any number of space separated tags.">Tags:</label>
                        <div class="col-sm-4">
                            <input class="form-control" rows="5" name="log_tags" id="elog_new_entry_tags" placeholder="Tag1 Tag2 Tag3"></input>
                        </div-->
                    </div>
                    <div class="form-group">
                        <label  class="col-sm-2 control-label" for="elog_new_entry_file_upload">File</label>
                        <div class="col-sm-10">
                            <input type="file" class="form-control" name="files" id="elog_new_entry_file_upload" multiple/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-default" id="elog_new_entry_modal_post">Post</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid text-center" id="elog_content">
</div>

</div>




<script type="text/javascript">
$("#elog_tab").on("lg.loaded.bs.tab", function() {

 var elog_header = `<div class="row exp_tab_header">
  <div class="col-md-3">Posted</div>
  <div class="col-md-1">Run</div>
  <div class="col-md-1">Length</div>
  <div class="col-md-5">Content</div>
  <div class="col-md-2">Author</div>
 </div>`;
 var elog_main_template = `<div class="edat" id="{{ _id }}"><div class="row">
  <div class="col-md-3">
    <span class="elog-expand elog-compressed exp_icons_left"><i class="fa fa-plus expand_ctrl"></i></span>
    {{#c_attach}}<span class="exp_icons_left"><i class="fa fa-paperclip expand_ctrl"></i></span>{{/c_attach}}
    {{#FormatDate}}{{ insert_time }}{{/FormatDate}}
  </div>
  <div class="col-md-1">{{ run_num }}</div>
  <div class="col-md-1">Length</div>
  {{> main_content_tmpl }}
  <div class="col-md-2">{{ author }}</div>
  </div></div>`;
  var elog_main_content_template = `<div class="col-md-5 elog_main_content text_truncate {{#deleted_by}}elog_deleted{{/deleted_by}} ">{{ content }}</div>`;

 var elog_child_template = `<div class="row col-md-12 elog-chid">
   <div class="panel panel-default">
    <div class="panel-heading text-left"><span class="entry_actions"><i class="fa fa-send fa-lg followup"></i>{{#roles.is_editor}}<i class="fa fa-edit fa-lg edit"></i><i class="fa fa-trash fa-lg delete"></i>{{/roles.is_editor}}</span><pre>{{content}}</pre></div>
    <div class="panel-body">
      {{> elog_chid_body_content }}
     <div class="row dialog_holder"></div>
    </div>
   </div>
 </div>`;
 var elog_chid_body_content = `<div class="elog_chid_body_content">{{#deleted_by}}<div class="row elog_deleted_by">Deleted by {{deleted_by}} - {{#FormatDate}}{{ deleted_time }}{{/FormatDate}}</div>{{/deleted_by}}
 <div class="row">{{#attachments}}<div class="col-xs-6 col-md-3"><a href="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=False" target="_blank" class="thumbnail"><img class="elog_img" src="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=true"></img></a></div>{{/attachments}}</div></div>`;

 var elog_followup_template = `<div class="row followup_div"><div class="panel col-sm-8"><div class="panel-body">
      <form class="form-horizontal followup_form" role="form">
       <button type="button" class="close">&times;</button>
       <input type="hidden" name="parent" value="{{ _id }}">
       <div class="validation_warning"></div>
       <div class="form-group"><label class="col-sm-2 control-label">Text</label><div class="col-sm-8"><textarea class="form-control" rows="5" name="log_text"></textarea></div></div>
       <div class="form-group"><label class="col-sm-2 control-label">File</label><div class="col-sm-8"><input type="file" class="form-control" name="files" multiple/></div></div>
       <div class="form-group"><button type="button" class="btn btn-default followup_post">Post</button></div>
      </form></div></div></div>`;

  Mustache.parse(elog_main_template);
  Mustache.parse(elog_main_content_template);
  Mustache.parse(elog_child_template);
  Mustache.parse(elog_chid_body_content);
  Mustache.parse(elog_followup_template);

  var renderMSTemplate = function(template, entry, partials) { // Convienience method to render time correctly.
    entry.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY HH:mm:ss");}};
    return $(Mustache.render(template, entry, partials));
  }

 var followup_function = function() {
	var entry = $(this).closest(".edat").data("entry");
	var rendered = renderMSTemplate(elog_followup_template, entry);
	rendered.find(".close").on("click", function(){
		$(this).closest(".followup_div").remove();
	});
	rendered.find(".followup_post").on("click", function(){
        if(_.isEmpty($.trim($(this).closest(".followup_form").find("textarea").val()))) { $(this).closest(".followup_form").find(".validation_warning").html("Please enter some text for the log message"); return false; }
		var formData = new FormData(rendered.find(".followup_form")[0]);
		$.ajax({
			url: 'ws/new_elog_entry',
			data: formData,
			type: 'POST',
			contentType: false, // Needed
			processData: false // Needed
		})
		.done(function(data, textStatus, jqXHR) {
			data = JSON.parse(data);
			if(data.success) {
				console.log("Successfully posted follow elog entry");
			} else {
				alert("Server side exception posting followup elog entry " + data.errormsg);
			}
		})
		.fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception posting followup elog entry " + jqXHR.responseText); })
		$(this).closest(".followup_div").remove();
	});

	$(this).closest(".elog-chid").find(".dialog_holder").html(rendered);
 }

 var edit_elog_entry = function() {
    var entry = $(this).closest(".edat").data("entry");
    var rendered = renderMSTemplate(elog_followup_template, entry);
 	rendered.find(".close").on("click", function(){
 		$(this).closest(".followup_div").remove();
 	});
    rendered.find("textarea").first().text(entry["content"]);
 	rendered.find(".followup_post").on("click", function(){
 		var formData = new FormData(rendered.find(".followup_form")[0]);
 		$.ajax({
 			url: 'ws/modify_elog_entry?_id='+encodeURIComponent(entry["_id"]),
 			data: formData,
 			type: 'POST',
 			contentType: false, // Needed
 			processData: false // Needed
 		})
 		.done(function(data, textStatus, jqXHR) {
 			data = JSON.parse(data);
 			if(data.success) {
 				console.log("Successfully edited elog entry");
 			} else {
 				alert("Server side exception editing elog entry " + data.errormsg);
 			}
 		})
 		.fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception editing elog entry " + jqXHR.responseText); })
 		$(this).closest(".followup_div").remove();
 	});
    $(this).closest(".elog-chid").find(".dialog_holder").html(rendered);
 }

 var delete_elog_entry = function() {
     var entry = $(this).closest(".edat").data("entry");
     $.getJSON({url: "ws/delete_elog_entry?_id="+encodeURIComponent(entry["_id"]), method: "DELETE" })
     .done(function(){})
     .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception deleting elog entry " + jqXHR.responseText); })
 }

 var expandFunction = function() {
	var entry = $(this).closest(".edat").data("entry");
	console.log("Expand/contract " + entry["_id"]);
	if($(this).hasClass("elog-expanded")) {
		$(this).closest(".edat").find(".elog-chid").remove();
    	$(this).html('<i class="fa fa-plus expand_ctrl"></i>');
	} else {
		var clicked_elem = $(this);
	    clicked_elem.closest(".edat").append(renderMSTemplate(elog_child_template, entry, { elog_chid_body_content: elog_chid_body_content } ));
	    clicked_elem.closest(".edat").find(".followup").on("click", followup_function);
        clicked_elem.closest(".edat").find(".delete").on("click", delete_elog_entry);
        clicked_elem.closest(".edat").find(".edit").on("click", edit_elog_entry);
		_.each(_.sortBy(_.map(entry["c_children"], function(chid) { return $("#elog_tab").data("entries")[chid]; }), function(s) { return s["inserted_time"]; }).reverse(), function(ch_entry) {
		    var rendered = renderMSTemplate(elog_main_template, ch_entry, { main_content_tmpl: elog_main_content_template });
		    rendered.data("entry", ch_entry).addClass("edesc");
		    clicked_elem.closest(".edat").find(".panel-body").append(rendered);
		    rendered.find(".elog-expand").on("click", expandFunction);
		});
    	$(this).html('<i class="fa fa-minus expand_ctrl"></i>');
	}
	$(this).toggleClass("elog-expanded elog-compressed");
 };

  var id2entry = {};
  var processNewEntry = function(entry) {
	  var root = _.get(entry, "root", null), parent = _.get(entry, "parent", null), attachments = _.get(entry, "attachments", null);
      if(attachments != null) {
    	  entry["c_attach"] = true;
    	  _.each(attachments, function(attachment) { attachment["entry_id"] = entry["_id"]; });
      }
      if(parent != null && _.has(id2entry, parent)) {
    	  var pey = id2entry[parent];
   		  _.defaults(pey, {"c_children": []});
   		  pey["c_children"] = _.union(pey["c_children"], [ entry["_id"] ]);
      }
      if(root != null && _.has(id2entry, root)) {
    	  var rey = id2entry[root];
   		  _.defaults(rey, {"c_desc": []});
   		  rey["c_desc"] = _.union(rey["c_desc"], [ entry["_id"] ]);
      }
      entry.roles = roles;
      id2entry[entry["_id"]] = entry;
  }

  var reattach_children = function(elog_entry) { // When getting a socket request, we may get an update on the pareant without getting an update on the children. Loop thru and reattach children
      _.each(id2entry, function(entry, key){
          var myid = elog_entry["_id"], root = _.get(entry, "root", null), parent = _.get(entry, "parent", null);
          if(parent != null && myid == parent) {
       		  elog_entry["c_children"] = _.union(elog_entry["c_children"], [ entry["_id"] ]);
          }
          if(root != null && myid == root) {
       		  elog_entry["c_desc"] = _.union(elog_entry["c_desc"], [ entry["_id"] ]);
          }
      });
  }

  $("#elog_tab").data("entries", id2entry);

  var processElogResponse = function(data) {
    _.each(data.value, function(entry) { processNewEntry(entry); });
  	$("#elog_content").html(elog_header);
  	_.each(_.sortBy(_.filter(data.value, function(f) { return !_.has(f, "root") }), function(s) { return s["inserted_time"]}).reverse(), function(entry) { // Show only the top level entries in descending order
  		if(! _.has(entry, "root")) {
  		    var rendered = renderMSTemplate(elog_main_template, entry, { main_content_tmpl: elog_main_content_template });
  		    rendered.data("entry", entry).addClass("etop");
  		    $("#elog_content").append(rendered);
  		}
  	});
    $(".elog-expand").on("click", expandFunction);
  };

  var skip_websocket_elog_messages = false;
  var load_elog_function = function() {
      var user_specified_log_entry_id = getURLParameter("_id");
      if(!_.isNil(user_specified_log_entry_id)) {
          console.log("Loading elog for specific entry " + user_specified_log_entry_id);
          $.getJSON({ url: "ws/search_elog", data: { "_id": user_specified_log_entry_id }}).done(function(data){
              processElogResponse(data);
              _.times(100, function(){ $(".elog-compressed").trigger("click"); });
              skip_websocket_elog_messages = true;
          });
      } else {
          $.getJSON("ws/elog")
          .done(function(data){
              skip_websocket_elog_messages = false;
              processElogResponse(data);
          });
      }
  };
  $("#elog_tab").data("refresh", load_elog_function);

  load_elog_function();

  $(document).on('elog', function(event, elogEvent) {
      if(skip_websocket_elog_messages) { console.log("Skipping elog message from server."); return; }
      var elogData = elogEvent.value;
      console.log("Processing elog event for experiment " + experiment_name + " id=" + elogData["_id"]);
      processNewEntry(elogData);
      reattach_children(elogData);
      var entryinserted = false;
      var newentrydt = moment(elogData['insert_time']);
      var rendered = renderMSTemplate(elog_main_template, elogData, { main_content_tmpl: elog_main_content_template });
      rendered.data("entry", elogData).addClass("etop");
      rendered.find(".elog-expand").on("click", expandFunction);
      var existingElem = $("#"+elogData["_id"]);
      if(existingElem.length > 0) {
          existingElem.data("entry", elogData);
          existingElem.find(".elog_main_content").first().replaceWith(renderMSTemplate(elog_main_content_template, elogData));
          existingElem.find(".elog-chid pre").first().text(elogData["content"]);
          existingElem.find(".elog_chid_body_content").first().replaceWith(renderMSTemplate(elog_chid_body_content, elogData));
          entryinserted = true;
          return;
      }
      if (!_.has(elogData, 'root') && !_.has(elogData, 'parent')) {
          $.each($("#elog_content").find(".etop"), function(i, entry) {
              var existing_entry = $(this).data("entry");
              if (!_.has(existing_entry, 'root') && !_.has(existing_entry, 'parent')) {
                  var existing_entry_dt = moment(existing_entry['insert_time']);
                  if (newentrydt.isAfter(existing_entry_dt)) {
                      $(this).before(rendered);
                      entryinserted = true
                      return false;
                  }
              } else { alert("We should never be here... Please report this to pcds-datamgt-l"); }
          });
          if(!entryinserted) {
              console.log("Inserting possible first entry");
              $("#elog_content").append(rendered);
              entryinserted = true;
          }
      } else {
          console.log("Child row of " + elogData["parent"]);
          $.each($("#"+elogData["parent"]).find(".edat"), function() {
              var existing_entry = $(this).data("entry");
              var existing_entry_dt = moment(existing_entry['insert_time']);
              if (newentrydt.isAfter(existing_entry_dt)) {
                  $(this).before(rendered);
                  entryinserted = true;
                  return false;
              }
          });
          if(!entryinserted) {
              console.log("Inserting possible first child entry");
              $("#"+elogData["parent"]).find(".panel-body").append(rendered);
              entryinserted = true;
          }
      }
  });

  $("#elog_tab").data("new_entry_click", function(e) {
	 e.preventDefault();
     $("#elog_new_entry_form")[0].reset();
	 $("#elog_new_entry_modal").modal();
 });

  $("#elog_new_entry_modal_post").on("click", function (e) {
	  var formData = new FormData($('#elog_new_entry_form')[0]);
      if(_.isEmpty($.trim($("#elog_new_entry_log_text").val()))) { $("#elog_new_entry_modal").find(".validation_warning").html("Please enter some text for the log message"); return false; }
	  $.ajax({
		    url: 'ws/new_elog_entry',
		    data: formData,
		    type: 'POST',
		    contentType: false, // Needed
		    processData: false // Needed
		})
		.done(function(data, textStatus, jqXHR) {
			data = JSON.parse(data);
			if(data.success) {
    			console.log("Successfully posted elog entry");
			} else {
				alert("Server side exception posting new elog entry " + data.errormsg);
			}
		})
		.fail(function(jqXHR, textStatus, errorThrown) { console.log(jqXHR); alert("Server side exception posting new elog entry " + jqXHR.responseText); })
	  $("#elog_new_entry_modal").modal("hide");
  });

  $("#elog_tab").data("search_text_input", function(e) {
      var search_text = $("#elog_search_text").val();
      if (!_.isNil(search_text)) {
          if(/^[0-9]+$/g.test(search_text)) {
              $.getJSON({ url: "ws/search_elog", data: { run_num : search_text }}).done(function(data){ processElogResponse(data); skip_websocket_elog_messages = true; });
          } else if(/^([0-9]+)-([0-9]+)$/g.test(search_text)) {
              var start_run_num = /^([0-9]+)-([0-9]+)$/g.exec(search_text)[1];
              var end_run_num   = /^([0-9]+)-([0-9]+)$/g.exec(search_text)[2];
              $.getJSON({ url: "ws/search_elog", data: { start_run_num : start_run_num, end_run_num: end_run_num }}).done(function(data){ processElogResponse(data); skip_websocket_elog_messages = true; });
          } else if(search_text.length > 2) {
              $.getJSON({ url: "ws/search_elog", data: { search_text : search_text }}).done(function(data){ processElogResponse(data); skip_websocket_elog_messages = true; });
          } else {
              $.getJSON("ws/elog").done(function(data){ processElogResponse(data); skip_websocket_elog_messages = false; });
          }
      } else {
          $.getJSON("ws/elog").done(function(data){ processElogResponse(data); skip_websocket_elog_messages = false; });
      }
  });

  $("#elog_tab").data("elog_attachments_only", function() {
      console.log("Getting data for attachments only");
      $.getJSON("ws/elog")
      .done(function(data){
          var attachments_only_template = `<div class="row">{{#attachments}}<div class="col-xs-6 col-md-3"><a href="?_id={{entry_id}}#eLog" class="thumbnail"><img class="elog_img" src="ws/attachment?entry_id={{entry_id}}&attachment_id={{_id}}&prefer_preview=true"></img></a></div>{{/attachments}}</div>`;
          Mustache.parse(attachments_only_template);
          var attachments_flat_list = [];
          _.each(data.value, function(entry) {
              if(_.has(entry, 'attachments')) {
                  _.each(entry.attachments, function(attachment){
                      attachment["entry_id"] = entry["_id"];
                      attachments_flat_list.push(attachment);
                  });
              }
          });
          var rendered = Mustache.render(attachments_only_template, { attachments: attachments_flat_list.reverse()});
          $("#elog_content").html(rendered);
      });
  });

});

$("#elog_tab").on("lg.shown.bs.tab", function() {
    var tab_toolbar = `<input type="text" placeholder="Search/Run/Run-Run" id="elog_search_text">
    <i class="fa fa-plus fa-lg" id="elog_new_entry" title="Post a new elog entry"></i>
    <i class="fa fa-paperclip fa-lg" id="elog_attachments_only" title="Toggle attachments only"></i>
    <i class="fa fa-strikethrough fa-lg" id="elog_deleted_entries" title="Toggle deleted entries"></i>`;
    var toolbar_rendered = $(tab_toolbar);
    $("#toolbar_for_tab").append(toolbar_rendered);
    $("#elog_new_entry").on("click", $("#elog_tab").data("new_entry_click"));
    $("#elog_attachments_only").on("click", function() {
        if($("#elog_attachments_only").hasClass("pushedin")) {
            $("#elog_tab").data("refresh")();
            skip_websocket_elog_messages = false;
        } else {
            $("#elog_tab").data("elog_attachments_only")();
            skip_websocket_elog_messages = true;
        }
        $("#elog_attachments_only").toggleClass("pushedin");
    });
    $("#elog_deleted_entries").on("click", function() {
        if($("#elog_deleted_entries").hasClass("pushedin")) {
            $("#elog_tab").find(".elog_deleted").closest(".edat").removeClass("hidden");
        } else {
            $("#elog_tab").find(".elog_deleted").closest(".edat").addClass("hidden");
        }
        $("#elog_deleted_entries").toggleClass("pushedin");
    });
    $("#elog_search_text").on("input", $("#elog_tab").data("search_text_input"));
});

</script>
