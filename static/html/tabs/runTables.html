<div class="container-fluid text-center tabcontainer" id="rtbl_tab">
 <ul class="nav nav-pills">
 </ul>

<div class="mdl_holder"></div>
<div class="container-fluid text-left" id="rtbl_content">
</div>
</div>

<script type="text/javascript">
$("#rtbl_tab").on("lg.loaded.bs.tab", function() {
  var run_tbl_pill_template = `{{#value}}<li class="nav-item"><a class="nav-link rtbl_pill {{#is_system_run_table}}rtbl_sys{{/is_system_run_table}}" data-toggle="tab" data-rtbl-name="{{name}}" href="#{{name}}" title="{{description}}">{{ name }}</a></li>{{/value}}`;
  var run_tbl_tbl = `<table class="table table-striped table-bordered table-hover table-condensed sticky-table"><thead></thead><tbody class="spgntr_append"></tbody></table>`;
  var run_tbl_def_tr = `<tr>
    <td><input name="label" class="nonblank form-control"/></td>
    <td><select name="type" class="rtbl_def_category_select nonblank form-control"><option value="">&nbsp;</option></select></td>
    <td><select name="source" class="rtbl_def_pvname_select nonblank form-control"><option value="">&nbsp;</option></select></td>
    <td>
        <div class="row p-0 m-0"><span class="rtbldef_action col-6"><i class="fas fa-plus fa-lg" aria-hidden="true"></i></span>
        <span class="rtbldef_action col-6"><i class="fas fa-trash fa-lg" aria-hidden="true"></i></span></div>
        <div class="row p-0 m-0"><span class="rtbldef_action col-6"><i class="fas fa-arrow-up fa-lg" aria-hidden="true"></i></span>
        <span class="rtbldef_action col-6"><i class="fas fa-arrow-down fa-lg" aria-hidden="true"></i></span></div>
    </td></tr>`;
  var run_tbl_def_category_selector = `{{#.}}<option value="{{.}}">{{.}}</option>{{/.}}`;
  var run_tbl_def_pvname_selector = `<select name="source" class='rtbl_def_pvname_select nonblank form-control'><option value=''></option>{{#.}}<option value="{{label}}" title="{{param_name}}">{{description}}</option>{{/.}}</select>`;
  Mustache.parse(run_tbl_pill_template);
  Mustache.parse(run_tbl_tbl);
  Mustache.parse(run_tbl_def_tr);
  Mustache.parse(run_tbl_def_category_selector);
  Mustache.parse(run_tbl_def_pvname_selector);

  var col_defs_dialog = function(editTableName) {
     $.when($.ajax('../../static/html/tabs/rtbl_def_modal.html'), $.getJSON('ws/run_table_sources'))
     .done(function(d1, d2) {
       var validations = [
        [function() { return $.trim($("#rtbl_def_name").val()) == ""; }, "Table name cannot be blank."],
        [function() { return $.trim($("#rtbl_def_desc").val()) == ""; }, "Please enter a brief description."],
        [function() { return !/^([\w-\s]+)$/.test($("#rtbl_def_name").val())}, "We limit the special characters that can be used in table names. Alpha-numeric with underscores and spaces only."],
        [function() { return !/^([0-9.]+)$/.test($("#rtbl_def_bin_size").val())}, "Please enter the size of each bin."],
        [function() { return !/^([0-9]+)$/.test($("#rtbl_sort_index").val())}, "Please enter an integer value for the sort index."],
        [function() { return $("#rtbl_def_table_type").val() == "generatedtable" && $.trim($("#rtbl_gentable_patterns").val()) == ""; }, "Please enter a pattern for the attribute names"],
        [function() { return $("#rtbl_def_table_type").val() != "generatedtable" && $("#rtbl_def_tbl tbody tr").filter(function(){ return $(this).find(".nonblank").filter(function(){return $(this).val() == "";}).length == 0;}).length <= 0; }, "At least one column definition should have a complete column definition."],
        [function() { return $("#rtbl_def_table_type").val() != "generatedtable" && _.some($("#rtbl_def_tbl tbody tr").filter(function(){ return $(this).find("[name=label]").val() != "" }).map(function(){ return $(this).find(".nonblank").filter(function(){return $(this).val() == "";}) }), "length") }, "If the column name for a column definition is defined, then the column source(s) must be defined as well"],
      ];
       var mdl = $(d1[0]), rtbl_sources = d2[0];
       _.defaults(rtbl_sources.value, {"Editables": []});
       rtbl_sources.value["Editables"].push({"label": "New Editable", "description": "Add a new editable run parameter", "source": "editable_params.", "category": "Editables" });
       $("#rtbl_content").prepend(mdl);
       $("#rtbl_content").data("run_table_sources", rtbl_sources);
       var template_tr = $(Mustache.render(run_tbl_def_tr), {});
       template_tr.find(".rtbl_def_category_select").append(Mustache.render(run_tbl_def_category_selector, _.keys(rtbl_sources.value)));
       template_tr.find(".rtbl_def_category_select").on("change", function(){
         $(this).parent().next().empty().html(Mustache.render(run_tbl_def_pvname_selector, _.sortBy(rtbl_sources.value[$(this).val()]), "description"));
       });
       mdl.find("#rtbl_def_table_type").on("change", function(){
           $("#rtbl_new_entry_modal").find(".ttype").addClass("d-none");
           $("#rtbl_new_entry_modal").find(".ttype_"+$("#rtbl_def_table_type").val()).removeClass("d-none");
       });
       template_tr.find(".fa-plus").parent().on("click", function(e){ e.preventDefault(); $(this).closest("tr").after(template_tr.clone(true)); });
       template_tr.find(".fa-trash").parent().on("click", function(e){ e.preventDefault(); $(this).closest("tr").remove(); });
       template_tr.find(".fa-arrow-up").parent().on("click", function(e){ e.preventDefault(); $(this).closest("tr").prev().before($(this).closest("tr")); });
       template_tr.find(".fa-arrow-down").parent().on("click", function(e){ e.preventDefault(); $(this).closest("tr").next().after($(this).closest("tr")); });
       if (!_.isNil(editTableName)) {
         console.log("Editing table " + editTableName);
         var tblDef = $("#rtbl_tab").data("tblData")[editTableName];
         $("#rtbl_def_name").val(tblDef["name"]);
         $("#rtbl_def_desc").val(tblDef["description"]);
         $("#rtbl_def_bin_size").val(_.get(tblDef, "bin_size", 1));
         $("#rtbl_sort_index").val(_.get(tblDef, "sort_index", 100));
         $("#rtbl_gentable_patterns").val(_.get(tblDef, "patterns", ".*"));
         $("#rtbl_gentable_showvalues").prop("checked", _.get(tblDef, "showvalues", true));
         $("#rtbl_def_table_type").val(_.get(tblDef, "table_type", "table")).trigger("change");
         _.each(_.tail(tblDef["coldefs"]), function(coldef, index){
             var coldefrow = template_tr.clone(true);
             coldefrow.find("[name='label']").val(coldef["label"]);
             var rtbl_src_obj = _.find(_.flatten(_.values(rtbl_sources.value)), function(rdf){return rdf['source'] == coldef["source"]});
             if(!_.isNil(rtbl_src_obj)) {
               coldefrow.find(".rtbl_def_category_select").val(rtbl_src_obj['category']);
               coldefrow.find(".rtbl_def_pvname_select").empty().html(Mustache.render(run_tbl_def_pvname_selector, rtbl_sources.value[rtbl_src_obj['category']])).val(rtbl_src_obj['label']);
             } else {
               console.log("Did not find param description for " + coldef["source"] + " Making one up.");
               rtbl_sources.value["EPICS:Additional parameters"].push({ label: _.replace(coldef["source"], "params.", ""), category: "EPICS:Additional parameters", source: coldef["source"] })
               coldefrow.find(".rtbl_def_category_select").val("EPICS:Additional parameters");
               coldefrow.find(".rtbl_def_pvname_select").empty().html(Mustache.render(run_tbl_def_pvname_selector, rtbl_sources.value["EPICS:Additional parameters"])).val(_.replace(coldef["source"], "params.", ""));
             }
             $("#rtbl_def_tbl tbody").append(coldefrow);
         });
       } else {
         $("#rtbl_def_tbl tbody").append(template_tr.clone(true));
       }
       $("#rtbl_def_post").on("click", function(e){
         var v_failed = false; // Various validations
         _.each(validations, function(validation, i) {
           if(validation[0]()) {
             e.preventDefault();
             error_message(validation[1]);
             v_failed = true;
             return false;
           }
         });
         if(!v_failed) {
           var tbl_def = {
             name: $("#rtbl_def_name").val(),
             description: $("#rtbl_def_desc").val(),
             is_editable: true,
             table_type: $("#rtbl_def_table_type").val(),
             sort_index: _.toInteger($("#rtbl_sort_index").val()),
             coldefs: []
           };
           if(tbl_def['table_type'] == "histogram") { tbl_def['bin_size'] = parseFloat($("#rtbl_def_bin_size").val()); }
           if(tbl_def['table_type'] == "generatedtable") { tbl_def['patterns'] = $.trim($("#rtbl_gentable_patterns").val()); tbl_def['showvalues'] = $("#rtbl_gentable_showvalues").is(':checked'); }
           if(tbl_def['table_type'] != "generatedtable") {
               $("#rtbl_def_tbl tbody tr").each(function(index, defnrow){
                 var colname = $(this).find("[name='label']").val();
                 var type = $(this).find("[name='type']").val();
                 var srclbl = $(this).find("[name='source']").val();
                 console.log("Looking for source for " + srclbl);
                 var source = (srclbl == "New Editable") ? "editable_params." + colname + ".value" : _.find($("#rtbl_content").data("run_table_sources").value[type], function(o){ return o['label'] == srclbl; })['source'];
                 tbl_def.coldefs.push({
                   label: colname,
                   type: type,
                   source: source,
                   is_editable: ((type == "Editables") || (_.startsWith(source, "params.Calibrations/"))),
                   position: index
                 })
               })
           }
       	   $.getJSON({
       		    url: 'ws/create_update_user_run_table_def',
       		    data: JSON.stringify(tbl_def),
              type: "POST",
       		    contentType: 'application/json'
       		 })
       		 .done(function(data, textStatus, jqXHR) {
       			 if(data.success) { console.log("Successfully updated user run table definition"); sessionStorage['runtable_active_tab'] = $("#rtbl_def_name").val(); window.location.reload(true); } else { alert("Server side exception updating user run table definition " + data.errormsg); }
       		 })
       		 .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception updating user run table definition " + jqXHR.responseText); })
           $("#rtbl_new_entry_modal").modal("hide");
         }
       });
       $("#rtbl_new_entry_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); });
       $("#rtbl_new_entry_modal").modal();
     });
  }

  var update_editable_for_run = function( input_elem ) {
    console.log("Updating editable column");
    $.getJSON({ url: "ws/run_table_editable_update", method: "POST", data: { runnum: input_elem.attr('data-run-num'), source: input_elem.attr('data-column-source'), value: input_elem.text()}})
    .done(function(data, textStatus, jqXHR){ if(data.success) { console.log("Successfully updated editable");} else { alert("Server side exception updating editable " + data.errormsg); }})
    .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception updating editable " + jqXHR.responseText)});
  }

  var rtnl_row_tmpl; // Set later below.
  var renderRunData = function() {
      this.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY HH:mm:ss");}};
      var rowRendered = $(Mustache.render(rtnl_row_tmpl, this));
      rowRendered.find("td").hover(
        function(){ $("#rtbl_content thead").find("[data-col-idx=" + $(this).closest("td").index() + "]").addClass("tblhighlight"); },
        function(){ $("#rtbl_content thead").find("[data-col-idx=" + $(this).closest("td").index() + "]").removeClass("tblhighlight"); });
      content_editable_trigger_change(rowRendered);
      rowRendered.find(".rtbl_editable_column").change(function(){ update_editable_for_run($(this))});
      rowRendered.find("td").hover(function() { let colnum = parseInt($(this).index()) + 1; $(this).closest("table").find('td:nth-child(' + colnum + ')').addClass('rbtl_col_hvr'); }, function() { let colnum = parseInt($(this).index()) + 1; $(this).closest("table").find('td:nth-child(' + colnum + ')').removeClass('rbtl_col_hvr')});
      return rowRendered;
  }

  var renderTabularData = function(coldefs, runData, sampleData) { // Render a tabluar run data...
      var numHdrRows = _.find([[6, 1], [12, 2], [18, 3], [0, 4]], function(v) { return (v[0] == 0 || coldefs.length < v[0]); })[1];
      var tblRndr = $(Mustache.render(run_tbl_tbl, {}));
      var hdr = _.times(numHdrRows, function() { return $("<tr/>"); }), row_tmpl = "";
      _.each(coldefs, function(coldef, idx) {
        if(idx > 0 && idx < numHdrRows) { hdr[idx%numHdrRows].append($("<th colspan='" + idx + "' class='rtbl_filler'>&nbsp;</th>"))};
        hdr[idx%numHdrRows].append($("<th colspan='"+ numHdrRows + "' class='rtbl_header' data-col-idx='" + idx + "' >" + coldef["label"] + "</th>"));
        if(coldef["source"] == "Separator") {
          row_tmpl = row_tmpl + "<td class='rtbl_separator'>&nbsp;</td>";
        } else if (coldef["is_editable"]) {
          row_tmpl = row_tmpl + "<td><div class='rtbl_editable_column_parent'><div contenteditable='true' data-run-num='{{num}}' data-column-source='" + coldef["source"] + "' class='rtbl_editable_column' title='Type and click outside the box to update'>{{" + coldef["source"] + "}}</div></div></td>";
        } else if(_.get(coldef, "tickifpresent", false)) {
          row_tmpl = row_tmpl + "<td class='text-center'>{{#" + coldef["source"]  + "}}<span class='rtblbooltick'><i class='fas fa-check'></i></span>{{/" + coldef["source"] + "}}</td>";
        } else if (_.endsWith(coldef["source"], "_time")) {
          row_tmpl = row_tmpl + "<td>{{#FormatDate}}{{" + coldef["source"] + "}}{{/FormatDate}}</td>";
        } else if (_.startsWith(coldef["mime_type"], "image/")) {
          row_tmpl = row_tmpl + "<td><img class='rtbl_thumbnail' src='{{" + coldef["source"] + "}}'></td>";
        } else {
          row_tmpl = row_tmpl + "<td>{{" + coldef["source"] + "}}</td>";
        }
      });
      tblRndr.find("thead").empty().append(hdr);
      tblRndr.data("samples", _.fromPairs(_.map(sampleData, function(o){return [o["_id"], o["name"]]})));
      $("#rtbl_content").html(tblRndr);
      sortable_paginator($("#rtbl_content").find("table"), "num", "num", true, 0, 400, 50);
      rtnl_row_tmpl = "<tr data-runnum={{num}} data-spgntr={{num}}>" + row_tmpl + "</tr>";

      Mustache.parse(rtnl_row_tmpl);
      _.each(runData, function(r){ r.render = renderRunData})
      $("#rtbl_content").find("table").data("spgntr").addObjects(runData);
      var thead_top = $("#rtbl_content .sticky-table thead")[0].getBoundingClientRect().top;
      $.each($("#rtbl_content .sticky-table thead th"), function(){
          $(this).css({"top": $(this)[0].getBoundingClientRect().top - thead_top + "px"});
      })
      $(window).scroll(function () {
        if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {
        $("#rtbl_content").find("table").data("spgntr").pageDown();
      }});
  }

  $.getJSON("ws/run_tables")
  .done(function(tblData){
    _.each(tblData.value, function(tdef){
      tdef.coldefs = _.sortBy(tdef.coldefs, function(v){ return v["position"];});
      tdef.coldefs.unshift({"label": "Run", "source": "num", "is_editable": false, "position": -1 })
    });
    $("#rtbl_tab").data("tblData", _.keyBy(tblData.value, function(o) {  return o.name; }));
    console.log($("#rtbl_tab").data("tblData"));
    var rendered = $(Mustache.render(run_tbl_pill_template, tblData));
    $("#rtbl_tab .nav-pills").append(rendered);
    rendered.find(".rtbl_pill").on("click", function() {
      let clkRTblName = $(this).attr("data-rtbl-name");
      console.log("Getting data for run table " + clkRTblName);
      sessionStorage['runtable_active_tab'] = clkRTblName;
      let tblDef = $("#rtbl_tab").data("tblData")[clkRTblName], coldefs = tblDef.coldefs;
      let rtbl_data_params = {"tableName": clkRTblName}, binCount = _.get(tblDef, "bin_count", 100);
      if(sample_showing_in_UI != null && sample_showing_in_UI != "All Samples") { rtbl_data_params["sampleName"] = sample_showing_in_UI; }
      $("#lgbk_body").addClass("busy");
      $.when($.getJSON("ws/run_table_data", rtbl_data_params), $.getJSON("ws/samples"))
      .done(function(d0, d1){
        let runData = d0[0], sampleData = d1[0];
        if(_.get(tblDef, "table_type") == "histogram" || _.get(tblDef, "table_type") == "scatter") {
          var plotlyDivName = _.get(tblDef, "name") + '_plotlydiv';
          $("#rtbl_content").html("<div id='" + plotlyDivName + "'></div>");
          var traces = [], layout = {};
          if(_.get(tblDef, "table_type") == "histogram") {
              layout = { barmode: "overlay", title: { text: clkRTblName }, xaxis: { title: { text: _.head(_.tail(tblDef.coldefs))["label"], xref: "paper" }}};
              _.each(_.tail(coldefs), function(coldef, idx) {
                traces.push({x: _.map(runData.value, function(rd){return _.get(rd, coldef["source"])}), type: "histogram", showlegend: true, name: coldef["label"]});
                _.last(traces)['xbins'] = {start: _.min(_.last(traces)['x']), end: _.max(_.last(traces)['x'])};
                let computedBinSize = ((_.last(traces)['xbins']['end'] - _.last(traces)['xbins']['start'])/binCount);
                _.last(traces)['xbins']['size'] = (_.isFinite(computedBinSize) && _.has(tblDef, "bin_size")) ? _.get(tblDef, "bin_size") : computedBinSize;
                console.log("Bin Size" + _.last(traces)['xbins']['size']);
              });
          } else if (_.get(tblDef, "table_type") == "scatter") {
              var dateformatfn = (_.endsWith(_.head(_.tail(coldefs))["source"], "_time")) ? function(d) { return moment(d).toDate() } : function(d) { return d };
              var xaxisdata = _.map(runData.value, function(rd){return dateformatfn(_.get(rd, _.head(_.tail(coldefs))["source"]))});
              _.each(_.tail(_.tail(coldefs)), function(coldef, idx) {
                traces.push({x: xaxisdata, y: _.map(runData.value, function(rd){return _.get(rd, coldef["source"])}), type: "scatter", mode: "markers", showlegend: true, name: coldef["label"]});
              });
              layout = { title: { text: clkRTblName }, xaxis: { title: { text: _.head(_.tail(coldefs))["label"], xref: "paper" }}};
              if(coldefs.length == 3){ layout["yaxis"] = { title: { text: _.last(coldefs)["label"], yref: "paper" }} }
          }
          Plotly.newPlot(plotlyDivName, traces, layout, {displaylogo: false});
          return;
        }
        if (_.get(tblDef, "table_type") == "groupbytable") {
            let mcd = _.tail(tblDef["coldefs"]), mrd = runData.value, scs = _.map(mcd, "source"), justvals = _.map(mrd, function(x){ return _.pick(x, scs) }), uniqvals = _.uniqWith(justvals, _.isEqual)
            _.each(uniqvals, function(uq){ uq["runs"] = []})
            _.each(mrd, function(r) {
                _.each(uniqvals, function(u) {
                    if(_.isEqual(_.pick(r, scs), _.pick(u, scs))) {
                        u["runs"].push(r["num"])
                        return false;
                    }
                })
            })
            uniqvals = _.reverse(_.sortBy(uniqvals, scs));
            _.each(uniqvals, function(uq, idx){ uq["num"] = idx})
            renderTabularData(_.concat(mcd, [{is_editable: false, label: "Runs", mime_type: "TEXT", position: mcd.length, source: "runs", type: "Run Info"}]), uniqvals, sampleData.value);
            return;
        }
        if (_.get(tblDef, "table_type") == "generatedtable") {
            let tickifpresent = !_.get(tblDef, "showvalues", true);
            coldefs = _.concat(coldefs, _.map(_.uniq(_.flatten(_.map(_.map(runData.value, "params"), _.keys))).sort(), function(x){ return { "label": x, "source": "params." + x, "tickifpresent": tickifpresent } }))
            if(tickifpresent) { _.each(runData.value, function(x){ _.each(_.keys(_.get(x, "params", {})), function(k){_.set(x, "params."+k, true)})})  }
        }
        renderTabularData(coldefs, runData.value, sampleData.value);
      })
      .fail(function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception getting data " + jqXHR.responseText)})
      .always(function(){ $("#lgbk_body").removeClass("busy"); })

      if(_.get(privileges, "edit", false)) {
          $("#toolbar_for_tab").find(".tlbr").show();
          $("#make_system_rtbl").hide();
          if(_.get(tblDef, 'is_system_run_table', false)) {
              $("#edit_rtbl").hide(); $("#make_system_rtbl").hide();
          } else {
              if(_.get(privileges, "ops_page", false)) {
                  $("#make_system_rtbl").show();
              }
              $("#edit_rtbl").show();
          }
      } else {
          $("#toolbar_for_tab").find(".tlbr").hide();
      }
    });
    rendered.find( _.has(sessionStorage, 'runtable_active_tab') ? ("[data-rtbl-name='" + sessionStorage['runtable_active_tab'] + "']") : ".rtbl_pill").first().trigger("click");
    sessionStorage.removeItem("runtable_active_tab");
    $(document).on('runs', function(event, runData) {
      console.log("Processing web socket event for run " + runData.value['num'] + " for experiment " + runData['experiment_name'] + " CRUD=" + runData["CRUD"]);
      console.log(runData);
      var tblRndr = $("#rtbl_content").find("table"), runSample = _.get(runData.value, 'sample', "");
      if(sample_showing_in_UI != null && sample_showing_in_UI != "All Samples" && runSample != sample_showing_in_UI) { console.log("Skipping updating run table for different sample " + runSample); return; }
      runData.value.render = renderRunData;
      let clkRTblName = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name"), tblDef = $("#rtbl_tab").data("tblData")[clkRTblName], coldefs = tblDef.coldefs;
      if (_.get(tblDef, "table_type") == "generatedtable") {
          let tickifpresent = !_.get(tblDef, "showvalues", true);
          coldefs = _.concat(coldefs, _.map(_.uniq(_.flatten(_.map(_.map(runData.value, "params"), _.keys))).sort(), function(x){ return { "label": x, "source": "params." + x, "tickifpresent": tickifpresent } }))
          if(tickifpresent) { _.each([runData.value], function(x){ _.each(_.keys(_.get(x, "params", {})), function(k){_.set(x, "params."+k, true)})})  }
      } else if(_.get(tblDef, "table_type") == "groupbytable") {
          let mcd = _.tail(tblDef["coldefs"]), scs = _.map(mcd, "source"), curr_run_key = _.map(runData.value, scs), disp_objs = $("#rtbl_content").find("table").data("spgntr").disp_objs;
          let existing_uniq_obj = _.find(disp_objs, function(dobj){ return _.isEqual(_.pick(runData.value, scs), _.pick(dobj, scs))});
          if(_.isNil(existing_uniq_obj)) {
              let new_uniq_obj = _.assign(_.pick(runData.value, scs), {"runs": [runData.value["num"]], "num": disp_objs.length + 1});
              new_uniq_obj.render = renderRunData;
              $("#rtbl_content").find("table").data("spgntr").addObject(new_uniq_obj);
          } else {
              existing_uniq_obj["runs"] = _.uniq(_.concat(existing_uniq_obj["runs"], [runData.value["num"]])).sort().reverse();
              $("#rtbl_content").find("table").data("spgntr").addObject(existing_uniq_obj);
          }
          return;
      }
      $("#rtbl_content").find("table").data("spgntr").addObject(runData.value);
    });

    $("#rtbl_tab").data("new_rtbl_fn", function(e) { col_defs_dialog(); });
    $("#rtbl_tab").data("edit_rtbl_fn", function(e) { var clkRTblName = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name"); col_defs_dialog(clkRTblName); });
    $("#rtbl_tab").data("csv_rtbl_fn", function(e) {
        let params = {}; params["runtable"] = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name");
        if(sample_showing_in_UI != null && sample_showing_in_UI != "All Samples") { params["sampleName"] = sample_showing_in_UI; }
        window.open("ws/runtables/export_as_csv?" + $.param(params), "_blank");
    });
    $("#rtbl_tab").data("del_rtbl_fn", function(e) {
        var clkRTblName = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name");
        $.ajax({ url: "ws/delete_run_table", "data": { table_name: clkRTblName, is_system_run_table: _.get($("#rtbl_tab").data("tblData")[clkRTblName], 'is_system_run_table', false)}, method: "DELETE"})
        .done(function(data) { if(_.get(data, "success", true)) { window.location.reload(true); } else { alert("Server side error deleting run table " + data.errormsg); }})
        .fail(function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure deleting run table " + textStatus); })
    });
    $("#rtbl_tab").data("clone_rtbl_fn", function(e) {
        var clkRTblName = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name");
        $.ajax("../../static/html/ms/gen_clone.html")
        .done(function(tmpl){
            Mustache.parse(tmpl);
            var t_tmpl = `Clone run table {{ existing_object_name }}`,
                title = Mustache.render(t_tmpl, {existing_object_name: clkRTblName}),
                rendered = $(Mustache.render(tmpl, {title: title, txtlbl: 'New run table name:', btnlbl: "Clone"}));
            rendered.find("#obj_clone_btn").on("click", function(e){
                console.log("Cloning a run table definition");
                e.preventDefault();
                var formObj = $("#rtbl_tab").find(".mdl_holder").find("form");
                var validations = [
                    [function() { return $.trim(formObj.find(".new_object_name").val()) == ""; }, "The name of the cloned table cannot be blank."],
                    [function() { return !/^([\w-\s]+)$/.test($.trim(formObj.find(".new_object_name").val()))}, "We limit the special characters that can be used in table names.  Alpha-numeric with underscores and spaces only."],
                    [function() { return _.find($("#rtbl_tab").data("tblData"), function(shf){return shf.name == $.trim(formObj.find(".new_object_name").val())}) != undefined }, "The run table name already exists."]
                ];
                // Various validations
                var v_failed = false;
                _.each(validations, function(validation, i) {
                    console.log("Trying validation " + i + "" + validation[1]);
                    if(validation[0]()) {
                        error_message(validation[1]);
                        v_failed = true;
                        return false;
                    }
                });
                if (v_failed) { e.preventDefault(); return; }
                $.getJSON({url: "ws/clone_run_table_def"+ "?existing_run_table_name=" + encodeURIComponent(clkRTblName) + "&new_run_table_name=" + encodeURIComponent($.trim(formObj.find(".new_object_name").val())), method: "POST"})
                .done(function(data, textStatus, jqXHR) {
                    if(data.success) {
                        console.log("Successfully cloned run table " + clkRTblName);
                        $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").modal("hide");
                        window.location.reload(true);
                    } else {
                        alert("Server side exception cloning run table " + data.errormsg);
                    }
                })
                .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure cloning run table " + textStatus); })
            });

            $("#rtbl_tab").find(".mdl_holder").append(rendered);
            $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#rtbl_tab").find(".mdl_holder").empty(); });
            $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").modal("show");
        });
    });
    $("#rtbl_tab").data("make_system_rtbl", function(e) {
        var clkRTblName = $("#rtbl_tab .nav-pills a.active").attr("data-rtbl-name");
        $.ajax("../../static/html/ms/gen_clone.html")
        .done(function(tmpl){
            Mustache.parse(tmpl);
            var t_tmpl = `Replace system run table with {{ existing_object_name }}`,
                title = Mustache.render(t_tmpl, {existing_object_name: clkRTblName}),
                rendered = $(Mustache.render(tmpl, {title: title, txtlbl: 'System run table name:', btnlbl: "Replace"}));
            rendered.find("#obj_clone_btn").on("click", function(e){
                console.log("Replacing system run table");
                e.preventDefault();
                var formObj = $("#rtbl_tab").find(".mdl_holder").find("form");
                var validations = [
                    [function() { return $.trim(formObj.find(".new_object_name").val()) == ""; }, "The name of the system run table cannot be blank."],
                    [function() { return !/^([\w-\s]+)$/.test($.trim(formObj.find(".new_object_name").val()))}, "We limit the special characters that can be used in table names. Alpha-numeric with underscores and spaces only."]
                ];
                // Various validations
                var v_failed = false;
                _.each(validations, function(validation, i) {
                    console.log("Trying validation " + i + "" + validation[1]);
                    if(validation[0]()) {
                        error_message(validation[1]);
                        v_failed = true;
                        return false;
                    }
                });
                if (v_failed) { e.preventDefault(); return; }
                $.getJSON({url: "ws/replace_system_run_table_def"+ "?existing_run_table_name=" + encodeURIComponent(clkRTblName) + "&system_run_table_name=" + encodeURIComponent($.trim(formObj.find(".new_object_name").val())), method: "POST"})
                .done(function(data, textStatus, jqXHR) {
                    if(data.success) {
                        console.log("Successfully replaced system run table with " + clkRTblName);
                        $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").modal("hide");
                        window.location.reload(true);
                    } else {
                        alert("Server side exception replacing system run table " + data.errormsg);
                    }
                })
                .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure replacing system run table " + textStatus); })
            });

            $("#rtbl_tab").find(".mdl_holder").append(rendered);
            $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#rtbl_tab").find(".mdl_holder").empty(); });
            $("#rtbl_tab").find(".mdl_holder").find(".edit_modal").modal("show");
        });
    });

    $("#rtbl_tab").on("lg.refresh", function() {
        $("#rtbl_tab").find(_.has(sessionStorage, 'runtable_active_tab') ? ("[data-rtbl-name='" + sessionStorage['runtable_active_tab'] + "']") : ".rtbl_pill").first().trigger("click");
    });
  });
});

$("#rtbl_tab").on("lg.shown.bs.tab", function() {
    var tab_toolbar = `<span id="new_rtbl" title="Create a new run table"><i class="fas fa-plus fa-lg tlbr"></i></span>
    <span id="edit_rtbl" title="Edit this run table"><i class="fas fa-edit fa-lg tlbr"></i></span>
    <span id="clone_rtbl" title="Clone this run table"><i class="fas fa-clone fa-lg tlbr"></i></span>
    <span id="del_rtbl" title="Delete this run table"><i class="fas fa-trash fa-lg tlbr"></i></span>
    <span id="export_rtbl" title="Export this run table as a CSV"><i class="fas fa-download fa-lg tlbr"></i></span>
    <span id="make_system_rtbl" title="Move this run table to the system run tables. These are visible to all experiments; the move will replace any system run table with the same name. This run table will be removed from this experiment."><i class="fab fa-superpowers fa-lg tlbr"></i></span>
    `;
    var toolbar_rendered = $(tab_toolbar);
    if(!_.get(privileges, "ops_page", false)) { toolbar_rendered.find("#make_system_rtbl").remove(); }
    $("#toolbar_for_tab").append(toolbar_rendered);
    $("#new_rtbl").on("click", function(e) { $("#rtbl_tab").data("new_rtbl_fn")(e)});
    $("#edit_rtbl").on("click", function(e) { $("#rtbl_tab").data("edit_rtbl_fn")(e)});
    $("#export_rtbl").on("click", function(e) { $("#rtbl_tab").data("csv_rtbl_fn")(e)});
    $("#clone_rtbl").on("click", function(e) { $("#rtbl_tab").data("clone_rtbl_fn")(e)});
    $("#del_rtbl").on("click", function(e) { $("#rtbl_tab").data("del_rtbl_fn")(e)});
    $("#make_system_rtbl").on("click", function(e) { $("#rtbl_tab").data("make_system_rtbl")(e)});
});

</script>
