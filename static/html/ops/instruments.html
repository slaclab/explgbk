<div class="container-fluid text-center tabcontainer" id="ops_instruments_tab">
<div class="row">
    <div id="ins_mdl_holder"></div>
    <div class="table-responsive">
        <table class="table table-condensed table-striped table-bordered" id="instrumentstbl">
            <thead><tr><th>Name</th><th>Description</th><th>Number of Stations</th><th>Edit</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script type="text/javascript">
$("#ops_instruments_tab").on("lg.loaded.bs.tab", function() {
  var editcreatefn = function(instr_obj) {
    $.ajax ("../static/html/ms/insedit.html")
    .done(function(tmpl){
      Mustache.parse(tmpl);
      instr_obj.paramkvs = _.map(instr_obj['params'], function(value, key) { return { key: key, value: value };});
      var rendered = $(Mustache.render(tmpl, instr_obj));
      rendered.find(".fa-plus").on("click", function(){ $(this).closest("tr").after($(this).closest("tr").clone(true).find("input").val("").end()); });
      rendered.find(".fa-trash").on("click", function(){ $(this).closest("tr").remove(); });
      if(_.has(instr_obj, '_id')) { rendered.find(".register_btn").text("Update");}
      rendered.find(".register_btn").on("click", function(e) {
        e.preventDefault();
        var formObj = $("#ins_mdl_holder").find("form");
        var validations = [
            [function() { return $.trim(formObj.find(".instrument_name").val()) == ""; }, "Instrument name cannot be blank."],
            [function() { return $.trim(formObj.find(".description").val()) == ""; }, "Please enter a description for the instrument."],
            [function() { return formObj.find("tbody tr").map(function() { return $(this).find("input.key").val() == "" ^ $(this).find("input.value").val() == ""; }).toArray().reduce(function(a, b) { return a + b; }, 0); }, "Every param that has a name must have a value and vice versa."]
          ];
        // Various validations
        var v_failed = false;
        _.each(validations, function(validation, i) {
          console.log("Trying validation " + i + "" + validation[1]);
          if(validation[0]()) {
              $("#ins_mdl_holder").find(".validation_message").html(validation[1]);
              $("#ins_mdl_holder").find(".validation_modal").modal("show");
              v_failed = true;
              return false;
          }
        });
        if (v_failed) { e.preventDefault(); return; }
        var instrument_name = $.trim(formObj.find(".instrument_name").val());
        var original_instrument_name = $.trim(formObj.find(".instrument_name_original").val());
        var ins_params = {};
        formObj.find("tbody tr").map(function() {  var key = $(this).find("input.key").val(), val = $(this).find("input.value").val(); if(key != "" && val != "") { ins_params[key] = val; }});

        var updating_existing_instrument = (original_instrument_name == instrument_name);
        var registration_doc = {
            "_id" : instrument_name,
            "description" : $.trim(formObj.find(".description").val()),
            "params": ins_params
        };

        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: create_update_instrument + "?instrument_name=" + encodeURIComponent(instrument_name) + "&create=" + (updating_existing_instrument ? false : true),
          data: JSON.stringify(registration_doc),
          dataType: "json"
        })
        .done(function(data, textStatus, jqXHR) {
          if(data.success) {
              console.log("Successfully processed instrument " + instrument_name);
              $("#ins_mdl_holder").find(".edit_modal").modal("hide");
              sessionStorage.setItem("ops_active_tab", "instruments");
              window.location.reload(true);
          } else {
            alert("Server side exception processing instrument " + data.errormsg);
          }
        })
        .fail( function(jqXHR, textStatus, errorThrown) { alert("Server side HTTP failure processing instrument " + textStatus); })
      });
      $("#ins_mdl_holder").append(rendered);
      $("#ins_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#ins_mdl_holder").empty(); });
      $("#ins_mdl_holder").find(".edit_modal").modal("show");
    });
  }
  $("#ops_instruments_tab").data("editcreatefn", editcreatefn);

  var instmpl = `{{#value}}<tr>
        <td class="instrument_lbl">{{ _id }}</td>
        <td>{{ description }}</td>
        <td>{{ params.num_stations}}</td>
        <td> <a class="editinsbtn" href="#"><i class="fa fa-edit"></i>&nbsp;</a> </td>
    </tr>{{/value}}`;
  Mustache.parse(instmpl);
  $.getJSON(instruments_url)
  .done(function(instruments){
    var rendered = $(Mustache.render(instmpl, instruments));
    rendered.find(".editinsbtn").on("click", function(e){
      e.preventDefault();
      console.log("Editing instrument " + insname);
      var insname = $(this).closest("tr").find("td").first().text();
      var instr_obj = _.find(instruments.value, function(instr){ return instr._id == insname; });
      editcreatefn(instr_obj);
    });
    $("#instrumentstbl tbody").append(rendered);
  });

  $("#ops_instruments_tab").on("lg.shown.bs.tab", function() {
      var tab_toolbar = `<i class="fa fa-plus fa-lg" id="new_instrument" title="Add a new instrument"></i>`;
      var toolbar_rendered = $(tab_toolbar);
      $("#toolbar_for_tab").append(toolbar_rendered);
      $("#new_instrument").on("click", function(){ $("#ops_instruments_tab").data("editcreatefn")({})});
  });
});
