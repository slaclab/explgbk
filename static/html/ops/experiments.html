<div class="container-fluid text-center tabcontainer" id="register_edit_exp_tab">
<div id="exp_mdl_holder"></div>
<div class="row">
    <div class="table-responsive">
        <table class="table table-condensed table-striped table-bordered" id="exp_searchresults">
            <thead><tr>
                <th data-sort-attr="name">Name</th>
                <th data-sort-attr="instrument">Instrument</th>
                <th data-sort-attr="start_time">Experiment start<i class="fas fa-sort-up sric"></i></th>
                <th data-sort-attr="end_time">Experiment end</th>
                <th data-sort-attr="contact_info">PI</th>
                <th data-sort-attr="leader_account">Leader Account</th>
                <th data-sort-attr="description">Description</th>
                <th>Edit</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script type="text/javascript">
$("#register_edit_exp_tab").on("lg.loaded.bs.tab", function() {
  var show_validation_message = function(message) {
    $("#exp_mdl_holder").find(".validation_message").html(message);
    $("#exp_mdl_holder").find(".validation_modal").modal("show");
  }
  $("#register_edit_exp_tab").data("register_experiment_function", function() { lgbk_create_edit_exp({ contact_info: "", start_time : moment(), end_time : moment().add(2, 'days')}); });

  var clone_exp = function() {
    var src_experiment_name = $(this).closest("tr").find("td").first().find("a").text()
    console.log("Cloning experiment " + src_experiment_name);
    $.ajax ("../static/html/ms/expclone.html")
    .done(function( tmpl ) {
      Mustache.parse(tmpl);
      var rendered = $(Mustache.render(tmpl, {src_experiment_name: src_experiment_name, name: src_experiment_name, cloning: true, clone_attrs: [{k: "Experimental Setup", v: "setup"}, {k: "Samples", v: "samples"}, {k: "Roles", v: "roles"}, {k: "Run Parameter Descriptions", v: "run_param_descriptions"}]}));
      rendered.find(".start_time").datetimepicker({defaultDate: moment(), sideBySide: true });
      rendered.find(".end_time").datetimepicker({defaultDate: moment().add(2, 'days'), sideBySide: true });
      rendered.find(".clone_btn").on("click", function(e) {
        e.preventDefault();
        var formObj = $("#exp_mdl_holder").find("form");
        var validations = [
            [function() { return $.trim(formObj.find(".experiment_name").val()) == ""; }, "Experiment name cannot be blank."],
            [function() { return $.trim(formObj.find(".experiment_name").val()) == formObj.find(".src_experiment_name").val(); }, "Experiment name cannot be the same as the original."],
            [function() { return $.trim(formObj.find(".start_time input").val()) == ""; }, "Please choose a valid start time."],
            [function() { return $.trim(formObj.find(".end_time input").val()) == ""; }, "Please choose a valid end time."],
            [function() { return formObj.find('.end_time').datetimepicker('date').isSameOrBefore(formObj.find('.start_time').datetimepicker('date'), 'minute') ; }, "The end time should be after the start time."]
          ];
        // Various validations
        var v_failed = false;
        _.each(validations, function(validation, i) {
          // console.log("Trying validation " + i + "" + validation[1]);
          if(validation[0]()) {
              show_validation_message(validation[1]);
              v_failed = true;
              return false;
          }
        });
        if (v_failed) { e.preventDefault(); return; }
        var experiment_name = $.trim(formObj.find(".experiment_name").val());
        var registration_doc = {
            "name" : experiment_name,
            "start_time" : formObj.find('.start_time').datetimepicker('date').toJSON(),
            "end_time" : formObj.find('.end_time').datetimepicker('date').toJSON()
        };
        formObj.find(".clone_attr:checked").each(function(){ registration_doc[$(this).attr("name")] = true; });
        console.log(registration_doc);

        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: clone_experiment_url + "?experiment_name=" + encodeURIComponent(experiment_name) + "&src_experiment_name=" + encodeURIComponent(src_experiment_name),
          data: JSON.stringify(registration_doc),
          dataType: "json"
        })
        .done(function(data, textStatus, jqXHR) {
          if(data.success) {
              console.log("Successfully cloned experiment " + experiment_name);
              $("#exp_mdl_holder").find(".edit_modal").modal("hide");
              sessionStorage.setItem("ops_active_tab", "experiments");
              sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
              window.location.reload(true);
          } else {
            show_validation_message("Server failure: " + data.errormsg);
          }
        })
        .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
      });
     $("#exp_mdl_holder").append(rendered);
     $("#exp_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#exp_mdl_holder").empty(); });
     $("#exp_mdl_holder").find(".edit_modal").modal("show");
    });
  };

  var rename_exp = function() {
      var src_experiment_name = $(this).closest("tr").find("td").first().find("a").text()
      console.log("Renaming experiment " + src_experiment_name);
      $.ajax ("../static/html/ms/exprename.html")
      .done(function( tmpl ) {
        Mustache.parse(tmpl);
        var rendered = $(Mustache.render(tmpl, {src_experiment_name: src_experiment_name}));
        rendered.find(".rename_btn").on("click", function(e) {
          e.preventDefault();
          var formObj = $("#exp_mdl_holder").find("form");
          var validations = [
              [function() { return $.trim(formObj.find(".experiment_name").val()) == ""; }, "Experiment name cannot be blank."],
              [function() { return $.trim(formObj.find(".experiment_name").val()) == formObj.find(".src_experiment_name").val(); }, "Experiment name cannot be the same as the original."],
            ];
          // Various validations
          var v_failed = false;
          _.each(validations, function(validation, i) {
            // console.log("Trying validation " + i + "" + validation[1]);
            if(validation[0]()) {
                show_validation_message(validation[1]);
                v_failed = true;
                return false;
            }
          });
          if (v_failed) { e.preventDefault(); return; }
          var experiment_name = $.trim(formObj.find(".experiment_name").val());
          var registration_doc = {};

          $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: rename_experiment_url + "?experiment_name=" + encodeURIComponent(src_experiment_name) + "&new_experiment_name=" + encodeURIComponent(experiment_name),
            dataType: "json"
          })
          .done(function(data, textStatus, jqXHR) {
            if(data.success) {
                console.log("Successfully renamed experiment " + src_experiment_name + " to " + experiment_name);
                $("#exp_mdl_holder").find(".edit_modal").modal("hide");
                sessionStorage.setItem("ops_active_tab", "experiments");
                sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
                window.location.reload(true);
            } else {
              show_validation_message("Server failure: " + data.errormsg);
            }
          })
          .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
        });
       $("#exp_mdl_holder").append(rendered);
       $("#exp_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#exp_mdl_holder").empty(); });
       $("#exp_mdl_holder").find(".edit_modal").modal("show");
      });
  }

  var lock_unlock_experiment = function() {
      var experiment_name = $(this).closest("tr").find("td").first().find("a").text()
      console.log("Locking/unlocking experiment " + experiment_name);
      $.ajax({
        type: "POST",
        url: lock_unlock_experiment_url + "?experiment_name=" + encodeURIComponent(experiment_name),
        dataType: "json"
      })
      .done(function(data, textStatus, jqXHR) {
        if(data.success) {
            console.log("Successfully locked experiment " + experiment_name);
            sessionStorage.setItem("ops_active_tab", "experiments");
            sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
            window.location.reload(true);
        } else {
          show_validation_message("Server failure: " + data.errormsg);
        }
      })
      .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
  }


  $("#register_edit_exp_tab").data("cur_sort_attr", "start_time");
  $("#register_edit_exp_tab").data("cur_sort_desc", false);
  var exper_template = `{{#value}}<tr data-expid="{{_id}}">
        <td> <a target="_blank" href="{{_id}}/">{{ name }}</a> </td>
        <td style="background:{{background}}; color:{{color}}; " > {{ instrument }} </td>
        <td> {{#FormatDate}}{{start_time }}{{/FormatDate}} </td>
        <td> {{#FormatDate}}{{end_time}}{{/FormatDate}} </td>
        <td> {{ contact_info }} </td>
        <td> {{ leader_account }} </td>
        <td> {{ description }} </td>
        <td class="ops_exp_icons"><span class="exp_edit" title="Edit"><i class="fas fa-edit fa-lg"></i></span><span class="exp_clone" title="Clone"><i class="far fa-clone fa-lg"></i></span><span class="exp_rename" title="Rename"><i class="fas fa-suitcase fa-lg"></i></span>{{#is_locked}}<span class="lock_unlock" title="Unlock"><i class="fas fa-unlock fa-lg"></i></span>{{/is_locked}}{{^is_locked}}<span class="lock_unlock" title="Lock"><i class="fas fa-lock fa-lg"></i></span>{{/is_locked}}</td>
    </tr>{{/value}}`;
  Mustache.parse(exper_template);

  var edit_exp_btn_action = function(){
    var expName = $(this).closest("tr").find("td").first().find("a").text()
    console.log("Editing experiment " + expName);
    lgbk_create_edit_exp($("#register_edit_exp_tab").data("name2info")[expName]);
  };

  var add_exps_to_search_results = function() { // Uses the mustache template to add the contents of data("search_results")
    var sorted_exps = _.sortBy($("#register_edit_exp_tab").data("search_results"), $("#register_edit_exp_tab").data("cur_sort_attr"));
    if(!$("#register_edit_exp_tab").data("cur_sort_desc")) { sorted_exps = _.reverse(sorted_exps); }
    var expdata = { value: sorted_exps };
    expdata.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY");}};
    var rendered = Mustache.render(exper_template, expdata);
    $("#exp_searchresults tbody").html(rendered);
    $("#exp_searchresults .ops_exp_icons .exp_edit").on("click", edit_exp_btn_action);
    $("#exp_searchresults .ops_exp_icons .exp_clone").on("click", clone_exp);
    $("#exp_searchresults .ops_exp_icons .exp_rename").on("click", rename_exp);
    $("#exp_searchresults .ops_exp_icons .lock_unlock").on("click", lock_unlock_experiment);
  }

  $("#register_edit_exp_tab").data("search_function", function() { // Register the search function.
    if($("#ops_exp_searchtext").val().length > 0) {
      var curnamerx = new RegExp(".*"+$("#ops_exp_searchtext").val()+".*", 'i');
      var matchexps = _.filter($("#register_edit_exp_tab").data("experiments"), function(exp) {
          return curnamerx.test(exp["name"]) || curnamerx.test(exp["contact_info"]) || curnamerx.test(exp["description"]);
      });
      $("#register_edit_exp_tab").data("search_results", matchexps);
      add_exps_to_search_results();
    } else {
        $("#register_edit_exp_tab").data("search_results", $("#register_edit_exp_tab").data("experiments"));
        add_exps_to_search_results();
    }
  });

  $.when($.getJSON({ url: experiments_url }), $.getJSON({ url: instruments_url }))
  .done(function(d0, d1) {
    var experiments = d0[0], instruments = _.keyBy(d1[0].value, "_id");
    $("#register_edit_exp_tab").data("experiments", experiments.value); // Prepare for searches.
    _.map($("#register_edit_exp_tab").data("experiments"), function(exp){ exp["background"] = _.get(instruments, exp["instrument"] + ".color", "inherit"); exp["color"] = _.has(instruments, exp["instrument"] + ".color") ? "white" : "black"; });
    $("#register_edit_exp_tab").data("name2info", _.keyBy(experiments.value, "name"));
    $("#register_edit_exp_tab").data("search_results", $("#register_edit_exp_tab").data("experiments"));
    add_exps_to_search_results();

    if(sessionStorage.getItem("scroll_to_exp_id") != null) {
        console.log("Scrolling to " + sessionStorage.getItem("scroll_to_exp_id"));
        var row = $('#exp_searchresults').find('tr[data-expid="' + sessionStorage.getItem("scroll_to_exp_id") + '"]');
        if(row.length > 0) { row[0].scrollIntoView(); }
        sessionStorage.removeItem("scroll_to_exp_id");
    }
  });

  $("#exp_searchresults th[data-sort-attr]").on("click", function() {
      var curr_attr = $("#register_edit_exp_tab").data("cur_sort_attr");
      var sel_attr = $(this).attr("data-sort-attr");
      if(curr_attr == sel_attr) {
          $("#register_edit_exp_tab").data("cur_sort_desc", !$("#register_edit_exp_tab").data("cur_sort_desc"));
          $(this).closest("th").find(".sric").remove();
      } else {
          $("#register_edit_exp_tab").data("cur_sort_attr", sel_attr)
          $("#register_edit_exp_tab").data("cur_sort_desc", true);
          $(this).closest("thead").find(".sric").remove();
      }
      $(this).closest("th").append($("#register_edit_exp_tab").data("cur_sort_desc") ? $('<i class="fas fa-sort-down sric"></i>') : $('<i class="fas fa-sort-up sric"></i>'))
      add_exps_to_search_results();
  });

  $("#register_edit_exp_tab").on("lg.shown.bs.tab", function() {
      var tab_toolbar = `<input type="text" placeholder="Search" id="ops_exp_searchtext">
      <span id="register_experiment" title="Register New Experiment"><i class="fas fa-plus fa-lg"></i></span>`;
      var toolbar_rendered = $(tab_toolbar);
      $("#toolbar_for_tab").append(toolbar_rendered);
      $("#ops_exp_searchtext").on("input", function(){ $("#register_edit_exp_tab").data("search_function")() });
      $("#register_experiment").on("click", function(){ $("#register_edit_exp_tab").data("register_experiment_function")() });
  });
});
