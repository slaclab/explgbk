<div class="container-fluid text-center tabcontainer" id="register_edit_exp_tab">
<div class="row">
    <div id="exp_mdl_holder"></div>
    <div class="table-responsive">
        <table class="table table-condensed table-striped table-bordered" id="exp_searchresults">
            <thead><tr><th>Name</th><th>First Run</th><th>Last Run</th><th>PI</th><th>Leader Account</th><th>Description</th><th>Edit</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script type="text/javascript">
$("#register_edit_exp_tab").on("lg.loaded.bs.tab", function() {
  var show_validation_message = function(message) {
      $("#exp_mdl_holder").find(".validation_message").html(message);
      $("#exp_mdl_holder").find(".validation_modal").modal("show");
  }
  var edit_exp = function(expInfo) {
    if(/.+\(.+\)/.test(expInfo['contact_info'])) {
      expInfo['contact_info_name'] = expInfo['contact_info'].split("(")[0];
      expInfo['contact_info_email'] = expInfo['contact_info'].split("(")[1].split(")")[0];
    } else {
      expInfo['contact_info_name'] = expInfo['contact_info'];
      expInfo['contact_info_email'] = expInfo['contact_info'];
    }
    expInfo['paramkvs'] = _.map(expInfo['params'], function(value, key) { return { key: key, value: value };});
    $.when($.ajax ("../static/html/ms/expreg.html"), $.getJSON(instruments_url))
    .done(function( d1, d2 ) {
      var tmpl = d1[0], instruments = d2[0], options = `{{#value}}<option value="{{ _id }}">{{ _id }}</option>{{/value}}`;
      Mustache.parse(tmpl); Mustache.parse(options);
      var rendered = $(Mustache.render(tmpl, expInfo));
      rendered.find(".start_time").datetimepicker({defaultDate: moment(expInfo['start_time']), sideBySide: true });
      rendered.find(".end_time").datetimepicker({defaultDate: moment(expInfo['end_time']), sideBySide: true });
      rendered.find(".instrument").append($(Mustache.render(options, instruments)));
      rendered.find(".instrument").val(expInfo['instrument']);
      rendered.find(".fa-plus").on("click", function(){ $(this).closest("tr").after($(this).closest("tr").clone(true).find("input").val("").end()); });
      rendered.find(".fa-trash").on("click", function(){ $(this).closest("tr").remove(); });
      rendered.find(".experiment_name").on("change", function(){
        console.log("Checking to see if experiment " + $(this).val() + " is registered in URAWI");
        $.getJSON(lookup_experiment_in_urawi, {"experiment_name": $(this).val()})
        .done(function (expdata) {
          console.log(expdata);
          if(expdata.success) {
            rendered.find(".description").val(expdata.value['proposalAbstract']);
            rendered.find(".pi_name").val(_.get(expdata.value, 'spokesPerson.firstName') + " " + _.get(expdata.value,'spokesPerson.lastName'));
            rendered.find(".pi_email").val(_.get(expdata.value, 'spokesPerson.email'));
            rendered.find(".leader_account").val(_.get(expdata.value, 'spokesPerson.account[0].unixName'));
            if (_.get(expdata.value, "startDate") != "") { rendered.find('.start_time').data("DateTimePicker").date(moment(_.get(expdata.value, "startDate"))) };
            if (_.get(expdata.value, "stopDate") != "") { rendered.find('.end_time').data("DateTimePicker").date(moment(_.get(expdata.value, "stopDate"))) };
          }
        });
      });
      if (_.has(expInfo, "name")) { rendered.find(".register_btn").text("Update"); }
      rendered.find(".register_btn").on("click", function(e) {
        e.preventDefault();
        var formObj = $("#exp_mdl_holder").find("form");
        var validations = [
            [function() { return $.trim(formObj.find(".experiment_name").val()) == ""; }, "Experiment name cannot be blank."],
            [function() { return $.trim(formObj.find(".instrument").val()) == ""; }, "Please choose a valid instrument."],
            [function() { return $.trim(formObj.find(".posix_group").val()) == ""; }, "Please choose a posix group for authorization."],
            [function() { return $.trim(formObj.find(".start_time input").val()) == ""; }, "Please choose a valid start time."],
            [function() { return $.trim(formObj.find(".end_time input").val()) == ""; }, "Please choose a valid end time."],
            [function() { return formObj.find('.end_time').data("DateTimePicker").date().isSameOrBefore(formObj.find('.start_time').data("DateTimePicker").date(), 'minute') ; }, "The end time should be after the start time."],
            [function() { return $.trim(formObj.find(".leader_account").val()) == ""; }, "Please specify the UNIX account of the leader for the experiment."],
            [function() { return $.trim(formObj.find(".pi_name").val()) == ""; }, "Please specify the full name of the principal investigator."],
            [function() { return $.trim(formObj.find(".pi_email").val()) == ""; }, "Please specify the email address for the principal investigator."],
            [function() {
              var email = $.trim(formObj.find(".pi_email").val());
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              return !re.test(email.toLowerCase());
              }, "Please specify the email address for the principal investigator."],
            [function() { return $.trim(formObj.find(".description").val()) == ""; }, "A brief description of the experiment is very helpful."],
            [function() { return formObj.find("tbody tr").map(function() { return $(this).find("input.key").val() == "" ^ $(this).find("input.value").val() == ""; }).toArray().reduce(function(a, b) { return a + b; }, 0); }, "Every param that has a name must have a value and vice versa."]
          ];
        // Various validations
        var v_failed = false;
        _.each(validations, function(validation, i) {
          // console.log("Trying validation " + i + "" + validation[1]);
          if(validation[0]()) {
              show_validation_message(validation[1]);
              v_failed = true;
              return false;
          }
        });
        if (v_failed) { e.preventDefault(); return; }
        var experiment_name = $.trim(formObj.find(".experiment_name").val());
        var original_experiment_name = $.trim(formObj.find(".experiment_name_original").val());
        var updating_existing_experiment = (original_experiment_name == experiment_name);
        var exp_params = {};
        formObj.find("tbody tr").map(function() {  var key = $(this).find("input.key").val(), val = $(this).find("input.value").val(); if(key != "" && val != "") { exp_params[key] = val; }});
        var registration_doc = {
            "name" : experiment_name,
            "instrument" : $.trim(formObj.find(".instrument").val()),
            "description" : $.trim(formObj.find(".description").val()),
            "start_time" : formObj.find('.start_time').data("DateTimePicker").date().toJSON(),
            "end_time" : formObj.find('.end_time').data("DateTimePicker").date().toJSON(),
            "leader_account" : $.trim(formObj.find(".leader_account").val()),
            "contact_info" : $.trim(formObj.find(".pi_name").val()) + " (" + $.trim($(".pi_email").val()) + ")",
            "posix_group" : $.trim(formObj.find(".posix_group").val()),
            "params": exp_params
        };

        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: (updating_existing_experiment ? update_experiment_url : register_experiment_url) + "?experiment_name=" + encodeURIComponent(experiment_name),
          data: JSON.stringify(registration_doc),
          dataType: "json"
        })
        .done(function(data, textStatus, jqXHR) {
          if(data.success) {
              console.log("Successfully submitted experiment " + experiment_name);
              $("#exp_mdl_holder").find(".edit_modal").modal("hide");
              sessionStorage.setItem("ops_active_tab", "experiments");
              sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
              window.location.reload(true);
          } else {
            show_validation_message("Server failure: " + data.errormsg);
          }
        })
        .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
      });
     $("#exp_mdl_holder").append(rendered);
     $("#exp_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#exp_mdl_holder").empty(); });
     $("#exp_mdl_holder").find(".edit_modal").modal("show");
    });
  };

  var clone_exp = function() {
    var src_experiment_name = $(this).closest("tr").find("td").first().find("a").text()
    console.log("Cloning experiment " + src_experiment_name);
    $.ajax ("../static/html/ms/expclone.html")
    .done(function( tmpl ) {
      Mustache.parse(tmpl);
      var rendered = $(Mustache.render(tmpl, {src_experiment_name: src_experiment_name, clone_attrs: [{k: "Experimental Setup", v: "setup"}, {k: "Samples", v: "samples"}, {k: "Roles", v: "roles"}, {k: "Run Parameter Descriptions", v: "run_param_descriptions"}]}));
      rendered.find(".start_time").datetimepicker({defaultDate: moment(), sideBySide: true });
      rendered.find(".end_time").datetimepicker({defaultDate: moment().add(2, 'days'), sideBySide: true });
      rendered.find(".clone_btn").on("click", function(e) {
        e.preventDefault();
        var formObj = $("#exp_mdl_holder").find("form");
        var validations = [
            [function() { return $.trim(formObj.find(".experiment_name").val()) == ""; }, "Experiment name cannot be blank."],
            [function() { return $.trim(formObj.find(".experiment_name").val()) == formObj.find(".src_experiment_name").val(); }, "Experiment name cannot be the same as the original."],
            [function() { return $.trim(formObj.find(".start_time input").val()) == ""; }, "Please choose a valid start time."],
            [function() { return $.trim(formObj.find(".end_time input").val()) == ""; }, "Please choose a valid end time."],
            [function() { return formObj.find('.end_time').data("DateTimePicker").date().isSameOrBefore(formObj.find('.start_time').data("DateTimePicker").date(), 'minute') ; }, "The end time should be after the start time."]
          ];
        // Various validations
        var v_failed = false;
        _.each(validations, function(validation, i) {
          // console.log("Trying validation " + i + "" + validation[1]);
          if(validation[0]()) {
              show_validation_message(validation[1]);
              v_failed = true;
              return false;
          }
        });
        if (v_failed) { e.preventDefault(); return; }
        var experiment_name = $.trim(formObj.find(".experiment_name").val());
        var registration_doc = {
            "name" : experiment_name,
            "start_time" : formObj.find('.start_time').data("DateTimePicker").date().toJSON(),
            "end_time" : formObj.find('.end_time').data("DateTimePicker").date().toJSON()
        };
        formObj.find(".clone_attr:checked").each(function(){ registration_doc[$(this).attr("name")] = true; });
        console.log(registration_doc);

        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: clone_experiment_url + "?experiment_name=" + encodeURIComponent(experiment_name) + "&src_experiment_name=" + encodeURIComponent(src_experiment_name),
          data: JSON.stringify(registration_doc),
          dataType: "json"
        })
        .done(function(data, textStatus, jqXHR) {
          if(data.success) {
              console.log("Successfully cloned experiment " + experiment_name);
              $("#exp_mdl_holder").find(".edit_modal").modal("hide");
              sessionStorage.setItem("ops_active_tab", "experiments");
              sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
              window.location.reload(true);
          } else {
            show_validation_message("Server failure: " + data.errormsg);
          }
        })
        .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
      });
     $("#exp_mdl_holder").append(rendered);
     $("#exp_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#exp_mdl_holder").empty(); });
     $("#exp_mdl_holder").find(".edit_modal").modal("show");
    });
  };

  var rename_exp = function() {
      var src_experiment_name = $(this).closest("tr").find("td").first().find("a").text()
      console.log("Renaming experiment " + src_experiment_name);
      $.ajax ("../static/html/ms/exprename.html")
      .done(function( tmpl ) {
        Mustache.parse(tmpl);
        var rendered = $(Mustache.render(tmpl, {src_experiment_name: src_experiment_name}));
        rendered.find(".rename_btn").on("click", function(e) {
          e.preventDefault();
          var formObj = $("#exp_mdl_holder").find("form");
          var validations = [
              [function() { return $.trim(formObj.find(".experiment_name").val()) == ""; }, "Experiment name cannot be blank."],
              [function() { return $.trim(formObj.find(".experiment_name").val()) == formObj.find(".src_experiment_name").val(); }, "Experiment name cannot be the same as the original."],
            ];
          // Various validations
          var v_failed = false;
          _.each(validations, function(validation, i) {
            // console.log("Trying validation " + i + "" + validation[1]);
            if(validation[0]()) {
                show_validation_message(validation[1]);
                v_failed = true;
                return false;
            }
          });
          if (v_failed) { e.preventDefault(); return; }
          var experiment_name = $.trim(formObj.find(".experiment_name").val());
          var registration_doc = {};

          $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: rename_experiment_url + "?experiment_name=" + encodeURIComponent(src_experiment_name) + "&new_experiment_name=" + encodeURIComponent(experiment_name),
            dataType: "json"
          })
          .done(function(data, textStatus, jqXHR) {
            if(data.success) {
                console.log("Successfully renamed experiment " + src_experiment_name + " to " + experiment_name);
                $("#exp_mdl_holder").find(".edit_modal").modal("hide");
                sessionStorage.setItem("ops_active_tab", "experiments");
                sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
                window.location.reload(true);
            } else {
              show_validation_message("Server failure: " + data.errormsg);
            }
          })
          .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
        });
       $("#exp_mdl_holder").append(rendered);
       $("#exp_mdl_holder").find(".edit_modal").on("hidden.bs.modal", function(){ $(".modal-body").html(""); $("#exp_mdl_holder").empty(); });
       $("#exp_mdl_holder").find(".edit_modal").modal("show");
      });
  }

  var lock_unlock_experiment = function() {
      var experiment_name = $(this).closest("tr").find("td").first().find("a").text()
      console.log("Locking/unlocking experiment " + experiment_name);
      $.ajax({
        type: "POST",
        url: lock_unlock_experiment_url + "?experiment_name=" + encodeURIComponent(experiment_name),
        dataType: "json"
      })
      .done(function(data, textStatus, jqXHR) {
        if(data.success) {
            console.log("Successfully locked experiment " + experiment_name);
            sessionStorage.setItem("ops_active_tab", "experiments");
            sessionStorage.setItem("scroll_to_exp_id", _.replace(experiment_name, " ", "_"));
            window.location.reload(true);
        } else {
          show_validation_message("Server failure: " + data.errormsg);
        }
      })
      .fail( function(jqXHR, textStatus, errorThrown) { show_validation_message("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
  }


  var exper_template = `{{#value}}<tr data-expid="{{_id}}">
        <td> <a target="_blank" href="{{_id}}/">{{ name }}</a> </td>
        <td> {{#FormatDate}}{{first_run.begin_time }}{{/FormatDate}} </td>
        <td> {{#FormatDate}}{{last_run.begin_time}}{{/FormatDate}} </td>
        <td> {{ contact_info }} </td>
        <td> {{ leader_account }} </td>
        <td> {{ description }} </td>
        <td class="ops_exp_icons"><i class="fa fa-edit" title="Edit"></i><i class="fa fa-clone" title="Clone"></i><i class="fa fa-suitcase" title="Rename"></i>{{#is_locked}}<i class="fa fa-unlock lock_unlock" title="Unlock"></i>{{/is_locked}}{{^is_locked}}<i class="fa fa-lock lock_unlock" title="Lock"></i>{{/is_locked}}</td>
    </tr>{{/value}}`;
  Mustache.parse(exper_template);

  var edit_exp_btn_action = function(){
    var expName = $(this).closest("tr").find("td").first().find("a").text()
    console.log("Editing experiment " + expName);
    edit_exp($("#register_edit_exp_tab").data("name2info")[expName]);
  };

  $.getJSON ({ url: experiments_url })
  .done(function( experiments ) {
    // Prepare for searches...
    var exp_names = []
    var name2info = {};
    _.forOwn(experiments.value, function(exp) {
        exp_names.push(exp['name']);
        name2info[exp['name']] = exp;
    });
    $("#register_edit_exp_tab").data("exp_names", exp_names);
    $("#register_edit_exp_tab").data("name2info", name2info);
    experiments.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY");}};
    var rendered = Mustache.render(exper_template, experiments);
    $("#exp_searchresults tbody").html(rendered);
    $("#exp_searchresults .ops_exp_icons .fa-edit").on("click", edit_exp_btn_action);
    $("#exp_searchresults .ops_exp_icons .fa-clone").on("click", clone_exp);
    $("#exp_searchresults .ops_exp_icons .fa-suitcase").on("click", rename_exp);
    $("#exp_searchresults .ops_exp_icons .lock_unlock").on("click", lock_unlock_experiment);
    $("#register_edit_exp_tab").data("search_function", function() { // Register the search function.
      if($("#ops_exp_searchtext").val().length > 0) {
        var curname = $("#ops_exp_searchtext").val();
        var matchexps = [];
        _.each($("#register_edit_exp_tab").data("exp_names"), function(exp_name){
          if(_.startsWith(exp_name, curname)) {
            matchexps.push($("#register_edit_exp_tab").data("name2info")[exp_name]);
          }
        });
        if(matchexps.length > 0) {
          var expdata = {value: matchexps};
            expdata.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY");}};
            var rendered = Mustache.render(exper_template, expdata);
            $("#exp_searchresults tbody").html(rendered);
            $("#exp_searchresults .ops_exp_icons .fa-edit").on("click", edit_exp_btn_action);
            $("#exp_searchresults .ops_exp_icons .fa-clone").on("click", clone_exp);
            $("#exp_searchresults .ops_exp_icons .fa-suitcase").on("click", rename_exp);
            $("#exp_searchresults .ops_exp_icons .lock_unlock").on("click", lock_unlock_experiment);
        }
      } else {
        var rendered = Mustache.render(exper_template, experiments);
        $("#exp_searchresults tbody").html(rendered);
      }
    });
    if(sessionStorage.getItem("scroll_to_exp_id") != null) {
        console.log("Scrolling to " + sessionStorage.getItem("scroll_to_exp_id"));
        var row = $('#exp_searchresults').find('tr[data-expid="' + sessionStorage.getItem("scroll_to_exp_id") + '"]');
        if(row.length > 0) { row[0].scrollIntoView(); }
        sessionStorage.removeItem("scroll_to_exp_id");
    }
    $("#register_edit_exp_tab").data("register_experiment_function", function() { edit_exp({ contact_info: "", start_time : moment(), end_time : moment().add(2, 'days')}); });
  });

  $("#register_edit_exp_tab").on("lg.shown.bs.tab", function() {
      var tab_toolbar = `<input type="text" placeholder="Search" id="ops_exp_searchtext">
      <i class="fa fa-plus fa-lg" id="register_experiment" title="Register New Experiment"></i>`;
      var toolbar_rendered = $(tab_toolbar);
      $("#toolbar_for_tab").append(toolbar_rendered);
      $("#ops_exp_searchtext").on("input", function(){ $("#register_edit_exp_tab").data("search_function")() });
      $("#register_experiment").on("click", function(){ $("#register_edit_exp_tab").data("register_experiment_function")() });
  });
});
