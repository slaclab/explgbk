<div class="container-fluid text-center tabcontainer" id="expswitch_tab">
<div id="switch_mdl_holder"></div>
<div class="row" id="switch_experiment_div">
  <div class="table-responsive">
    <table class="table table-condensed table-striped table-bordered">
      <thead><tr><th>Instrument</th><th>Station</th><th>Experiment</th><th>PI</th><th>Leader Account</th><th>Current Sample</th><th>Current Run</th><th>Description</th><th>Switched at</th><th>Switched by</th><th><i class="fas fa-exchange-alt fa-lg" aria-hidden="true"></i></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="modal fade" data-backdrop="static" tabindex="-1" role="dialog" id="expswitch_choose_experiment">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title w-100"><span class="expswitch_choose_experiment_title">Choose an experiment</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </h4>
        </div>
      <div class="modal-body">
        <div class="locked_warning"><small>If you do not find the experiment listed here; it is possible that the experiment has been locked and can no longer used for data taking.
            If you need to activate this for other reasons or if this poses a problem, please contact your POC</small></div>
	    <div class="table-responsive">
	      <table class="table table-condensed table-striped table-bordered">
	        <thead><tr><th>Name</th><th>PI</th><th>Leader</th><th>Description</th></tr></thead>
	        <tbody></tbody>
	      </table>
	    </div>
      </div>
      <div class="modal-footer">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-default" id="switch_experiment">Switch experiment</button>
          </div>
      </div>
    </div>
  </div>
</div>
</div>


<script type="text/javascript">
$("#expswitch_tab").on("lg.loaded.bs.tab", function() {
	var instrument_template = `{{#value}}<tr {{#is_standby}}class="exp_switch_standby"{{/is_standby}}">
	<td style="background:{{background}}; color:{{color}}; " >{{ instrument }}</td>
	<td>{{ station }}</td>
	<td>{{#is_standby}}Standby{{/is_standby}}{{^is_standby}}<a target="_blank" href="{{_id}}/">{{ name }}</a>{{/is_standby}}</td>
    <td>{{ contact_info }}</td>
    <td>{{ leader_account }}</td>
    <td>{{ current_sample }}</td>
    <td {{#current_run}}{{^current_run.end_time}}class="expswitch_run_open" title="The run is still active as of {{#FormatDateTime}}{{ current_run.begin_time }}{{/FormatDateTime}}"{{/current_run.end_time}}{{#current_run.end_time}} title="The run was marked done at {{#FormatDateTime}}{{ current_run.end_time }}{{/FormatDateTime}}"{{/current_run.end_time}}>{{ current_run.num }}{{/current_run}}</td>
	<td>{{ description }}</td>
	<td>{{#FormatDateTime}}{{ switch_time }}{{/FormatDateTime}}</td>
	<td>{{ requestor_uid }}</td>
	<td class="ops_switch_icons">
      <span class="expswitch" data-instrument="{{ instrument }}" data-station="{{ station }}" title="Switch to a new experiment"><i class="fas fa-exchange-alt fa-lg" aria-hidden="true"></i></span>
      {{^is_standby}}<span class="standby"  data-instrument="{{ instrument }}" data-station="{{ station }}" title="Put this station in standby mode."><i class="fas fa-power-off fa-lg" aria-hidden="true"></i></span>{{/is_standby}}
      <span class="switch_history" data-instrument="{{ instrument }}" data-station="{{ station }}" title="Show the history of changes to this instrument station"><i class="fas fa-history fa-lg"></i></span>
    </td>
	</tr>{{/value}}`;

	var exper_template = `{{#value}}<tr data-expname="{{ name }}">
	    <td> <a target="_blank" href="{{_id}}/">{{ name }}</a> </td>
        <td> {{ contact_info }} </td>
        <td> {{ leader_account }} </td>
	    <td> {{ description }} </td>
	</tr>{{/value}}`;

	Mustache.parse(instrument_template);
	Mustache.parse(exper_template);

    $(document).ready(function() {
    	$("#switch_experiment").on("click", function(){
    		var exp_switch_info = $('#expswitch_choose_experiment table').data("selected-experiment");
    		console.log("Switching " + exp_switch_info.instrument + " station " + exp_switch_info.station + " to experiment " + exp_switch_info.experiment_name);
    		$("#expswitch_choose_experiment").modal("hide");
    		$.ajax({
    			type: "POST",
    			contentType: "application/json; charset=utf-8",
    			url: switch_experiment_url,
    			data: JSON.stringify(exp_switch_info),
    			dataType: "json"
    		})
    		.done(function(data, textStatus, jqXHR) {
    			if(data.success) {
        			console.log("Successfully switched " + exp_switch_info.instrument + " station " + exp_switch_info.station + " to experiment " + exp_switch_info.experiment_name);
        			location.reload();
    			} else {
    				alert("Server side exception switching experiment " + data.errormsg);
    			}
    		})
    		.fail( function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); if(jqXHR.status == 403){ alert("You don't seem to have permissions for this operation. Please contact the site administrators."); return;}; alert("Server side exception switching experiment " + jqXHR.responseText); })
    	});
    	$.when($.getJSON(active_experiments_url), $.getJSON(instrument_station_list), $.getJSON({ url: instruments_url }))
    	.done(function(d1, d2, d3) {
			var active_exps = d1[0], ins_st_list = d2[0], instruments = _.keyBy(d3[0].value, "_id");
			var others = _.differenceWith(ins_st_list.value, active_exps.value, function(av, ov){ return av['instrument'] == ov['instrument'] && av['station'] == ov['station'] });
			_.each(others, function(ot){ active_exps.value.push(ot); });
            _.each(active_exps.value, function(exp){ exp["background"] = _.get(instruments, exp["instrument"] + ".color", "inherit"); exp["color"] = _.has(instruments, exp["instrument"] + ".color") ? "white" : "black"; });
            active_exps.FormatDate = elog_formatdate;
            active_exps.FormatDateTime = elog_formatdatetime;
    		var rendered = Mustache.render(instrument_template, active_exps);
    		$("#switch_experiment_div tbody").html(rendered);
    		$("span.expswitch").on("click", function() {
    			var instr = $(this).attr("data-instrument");
    			var station = $(this).attr("data-station");
    			console.log("Switch " + instr + "/" + station);
    			$("#expswitch_choose_experiment .expswitch_choose_experiment_title").text("Choose new experiment for " + instr + " Station: " + station + "");
    			$.getJSON(experiments_by_instrument)
    			.done(function(data) {
    				let experiments_for_instrument = _.filter(data.value[instr], function(x){ return !_.get(x, "is_locked", false)}),
                        any_locked = _.some(data.value[instr], function(x){ return _.get(x, "is_locked", false)});
                    if(any_locked) { $('#expswitch_choose_experiment .locked_warning').removeClass("d-none") } else { $('#expswitch_choose_experiment .locked_warning').addClass("d-none") }
    				var rendered = Mustache.render(exper_template, {value: experiments_for_instrument});
    				$("#expswitch_choose_experiment table tbody").html(rendered);
    				$('#expswitch_choose_experiment table').on('click', 'tbody tr', function(event) {
    					$(this).find("td").addClass('rowselect');
    					$(this).siblings().find("td").removeClass('rowselect');
    					$('#expswitch_choose_experiment table').data("selected-experiment", {instrument: instr, station: station, experiment_name: $(this).attr("data-expname")});
    				});
    				$("#expswitch_choose_experiment").modal("show");
    			}).fail(function() {
    				alert("There was an error fetching experiments from the server.");
    			});
    		})
            $("span.standby").on("click", put_instrument_in_standby);

            $("span.switch_history").on("click", function(){
                let instrument = $(this).attr("data-instrument"), station=$(this).attr("data-station");
                $.when($.ajax ("../static/html/ms/switch_history.html"), $.getJSON("ws/instrument_switch_history", {"instrument": instrument, "station": station}))
                .done(function( d0, d1 ) {
                    let htmpl = d0[0], shistories = d1[0].value, ish = {"instrument": instrument, "station": station, "switches": shistories};
                    Mustache.parse(htmpl);
                    ish.FormatDate = elog_formatdatetime;
                    let rend = Mustache.render(htmpl, ish);
                    $("#switch_mdl_holder").empty().append(rend);
                    $("#switch_mdl_holder").find(".modal").on("hidden.bs.modal", function(){ $("#switch_mdl_holder").empty(); });
                    $("#switch_mdl_holder").find(".modal").modal("show");

                });
            })
    	});
    });
});
