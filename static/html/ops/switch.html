<div class="container-fluid text-center tabcontainer" id="expswitch_tab">
<div class="row" id="switch_experiment_div">
  <div class="table-responsive">
    <table class="table table-condensed table-striped table-bordered">
      <thead><tr><th>Instrument</th><th>Station</th><th>Experiment</th><th>PI</th><th>Leader Account</th><th>Description</th><th>Switched at</th><th>Switched by</th><th><i class="fa fa-exchange fa-lg" aria-hidden="true"></i></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="choose_experiment_modal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-header">
        <h4 class="modal-title">Choose an experiment</h4>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-default" id="switch_experiment">Switch experiment</button>
        </div>
      </div>
      <div class="modal-body">
	    <div class="table-responsive">
	      <table class="table table-condensed table-striped table-bordered">
	        <thead><tr><th>Name</th><th>PI</th><th>Leader</th><th>Description</th></tr></thead>
	        <tbody></tbody>
	      </table>
	    </div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
</div>


<script type="text/javascript">
$("#expswitch_tab").on("lg.loaded.bs.tab", function() {
	var instrument_template = `{{#value}}<tr {{#is_standby}}class="exp_switch_standby"{{/is_standby}}">
	<td>{{ instrument }}</td>
	<td>{{ station }}</td>
	<td>{{#is_standby}}Standby{{/is_standby}}{{^is_standby}}<a target="_blank" href="{{_id}}/">{{ name }}</a>{{/is_standby}}</td>
    <td>{{ contact_info }}</td>
    <td>{{ leader_account }}</td>
	<td>{{ description }}</td>
	<td>{{#FormatDate}}{{ switch_time }}{{/FormatDate}}</td>
	<td>{{ requestor_uid }}</td>
	<td class="ops_switch_icons">
      <i class="fa fa-exchange fa-lg expswitch" aria-hidden="true" data-instrument="{{ instrument }}" data-station="{{ station }}" title="Switch to a new experiment"></i>
      {{^is_standby}}<i class="fa fa-power-off fa-lg standby" aria-hidden="true" data-instrument="{{ instrument }}" data-station="{{ station }}" title="Put this station in standby mode."></i>{{/is_standby}}
    </td>
	</tr>{{/value}}`;

	var exper_template = `{{#value}}<tr data-expname="{{ name }}">
	    <td> <a target="_blank" href="{{_id}}/">{{ name }}</a> </td>
        <td> {{ contact_info }} </td>
        <td> {{ leader_account }} </td>
	    <td> {{ description }} </td>
	</tr>{{/value}}`;

	Mustache.parse(instrument_template);
	Mustache.parse(exper_template);

    $(document).ready(function() {
    	$("#switch_experiment").on("click", function(){
    		var exp_switch_info = $('#choose_experiment_modal table').data("selected-experiment");
    		console.log("Switching " + exp_switch_info.instrument + " station " + exp_switch_info.station + " to experiment " + exp_switch_info.experiment_name);
    		$("#choose_experiment_modal").modal("hide");
    		$.ajax({
    			type: "POST",
    			contentType: "application/json; charset=utf-8",
    			url: switch_experiment_url,
    			data: JSON.stringify(exp_switch_info),
    			dataType: "json"
    		})
    		.done(function(data, textStatus, jqXHR) {
    			if(data.success) {
        			console.log("Successfully switched " + exp_switch_info.instrument + " station " + exp_switch_info.station + " to experiment " + exp_switch_info.experiment_name);
        			location.reload();
    			} else {
    				alert("Server side exception switching experiment " + data.errormsg);
    			}
    		})
    		.fail( function(jqXHR, textStatus, errorThrown) { console.log(errorThrown); alert("Server side exception switching experiment " + jqXHR.responseText); })
    	});
    	$.when($.getJSON(active_experiments_url), $.getJSON(instrument_station_list))
    	.done(function(d1, d2) {
				var active_exps = d1[0], ins_st_list = d2[0];
				var others = _.differenceWith(ins_st_list.value, active_exps.value, function(av, ov){ return av['instrument'] == ov['instrument'] && av['station'] == ov['station'] });
				_.each(others, function(ot){ active_exps.value.push(ot); });
    		active_exps.FormatDate = function() { return function(dateLiteral, render) { var dateStr = render(dateLiteral); return dateStr == "" ? "" : moment(dateStr).format("MMM/D/YYYY");}};
    		var rendered = Mustache.render(instrument_template, active_exps);
    		$("#switch_experiment_div tbody").html(rendered);
    		$(".fa.expswitch").on("click", function() {
    			var instr = $(this).attr("data-instrument");
    			var station = $(this).attr("data-station");
    			console.log("Switch " + instr + "/" + station);
    			$("#choose_experiment_modal .modal-title").text("Choose new experiment for " + instr + " Station: " + station + "");
    			$.getJSON(experiments_by_instrument)
    			.done(function(data) {
    				var experiments_for_instrument = data.value[instr];
    				var rendered = Mustache.render(exper_template, {value: experiments_for_instrument});
    				$("#choose_experiment_modal table tbody").html(rendered);
    				$('#choose_experiment_modal table').on('click', 'tbody tr', function(event) {
    					$(this).find("td").addClass('rowselect');
    					$(this).siblings().find("td").removeClass('rowselect');
    					$('#choose_experiment_modal table').data("selected-experiment", {instrument: instr, station: station, experiment_name: $(this).attr("data-expname")});
    				});
    				$("#choose_experiment_modal").modal("show");
    			}).fail(function() {
    				alert("There was an error fetching experiments from the server.");
    			});
    		})
            $(".fa.standby").on("click", function() {
                var instr = $(this).attr("data-instrument");
    			var station = $(this).attr("data-station");
    			console.log("Putting " + instr + "/" + station + " into standby/maintenance mode.");
                $.ajax({
        			type: "POST",
        			contentType: "application/json; charset=utf-8",
        			url: instrument_standby_url,
        			data: JSON.stringify({"instrument": instr, "station": station}),
        			dataType: "json"
        		})
                .done(function(data){
                    if(data.success) {
            			console.log("Successfully put "+ instr + "/" + station + " into standby/maintenance mode.");
            			location.reload();
        			} else {
        				alert("Server side exception switching experiment " + data.errormsg);
        			}
                })
                .fail( function(jqXHR, textStatus, errorThrown) { alert("Server failure: " + _.get(jqXHR, "responseText", textStatus))})
            });
    	});
    });
});
